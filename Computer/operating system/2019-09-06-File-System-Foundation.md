---
title: 4.1 File System Foundation
date: 2019-10-10
---

思考如下问题

1. 什么是文件？什么是文件系统？
2. 文件系统要完成哪些功能？

切记区分逻辑结构和物理结构。

不要忽略对基本概念的理解。

计算机内存在断电情况下不能保存数据，且容量有限，因此现代系统都有配置外存。外存用来存放数据，为了方便用户使用文件，操作系统添加了文件管理功能，专门管理在外存上的文件，并把对文件的存取、共享和保护等手段提供给用户，这样不仅提高了文件的安全性，还可有效地提高系统资源的利用率。

## 1. 文件的概念

### 1.1 文件的定义

文件（File）是操作系统中的一个重要概念。文件是以计算机硬盘为载体的存储在计算机上的信息集合，文件可以是文本文档、图片、程序等。在系统运行时，计算机以进程为基本单位进行资源的调度和分配，而在用户进行的输入、输出中，则以文件为基本单位。大多数应用程序的输入都是通过文件来实现的，其输出也保存在文件中，以便信息的长期存储及将来的访问。当用户将文件用于应用程序的输入、输出时，还希望可以访问文件、修改文件和保存文件等，实现对文件的维护管理，这就需要系统提供一个文件管理系统，操作系统中的文件系统（File System）就是用于实现用户的这些管理要求的。

要清晰地理解文件的概念，就要了解文件究竟由哪些东西组成。

首先，文件中肯定包括一块存储空间，更准确地说，是存储空间中的数据，其次，由于操作系统要管理成千上万的数据，因此必定需要对这些数据进行划分，然后贴上 “标签”，以便于分类和索引，所以文件必定包括分类和索引的信息；最后，不同的用户拥有对数据的不同访问权限，因此文件中一定包含一些关于访问权限的信息。

再举生活中的一个直观例子来类比文件。可以认为，计算机中的一个文件相当于图书馆中的一本书，操作系统管理文件，相当于图书管理员管理图书馆中的书。

首先，一本书的主体一定是书中的内容，相当于文件中的数据；其次，不同类别的书需要放在不同的书库，然后加上编号，再把编号登记再图书管理系统中，方便读者查阅，相当于文件中的分类和查找；最后，有些已经绝版或价格比较高的外文书籍，只能借给 VIP 会员或权限比较高的其他读者，而有些普通的书籍可供任何人借阅，这就是文件中的访问权限。

例子可能不严谨，但是思想却有相一致的地方，因此大家有个大概印象。

从用户的角度看，文件系统是操作系统的重要部分之一。用户关心的是如何命名、分类和查找文件，如何保证文件数据的安全性及对文件可以进行哪些操作等。而对其中的细节，如文件如何存储在辅存上、如何管理文件辅存区域等关心甚少。

文件系统提供了与二级存储相关的资源的抽象，让用户能在不了解文件的各种属性、文件存储介质的特征及文件在存储介质上的具体位置等情况下，方便快捷地使用文件。

用户通过文件系统建立文件，提供应用程序的输入、输出，对资源进行管理。首先了解文件的结构，我们通过自底向上的方式来定义。

1. 数据项

   分为基本数据项和组合数据项，类比数据库。例如学号就是一个基本数据项，而工资就是组合数据项（基本工资，工龄工资和奖励工资）。

   数据项包括数据类型和值，例如名字是字符类型，值就是一串字符。学号是数据类型，值是一个整数。相当于一个 key 对应一个 value 。

2. 记录

   记录是一组相关数据项的组合，类比数据库，用于描述一个对象在某方面的属性。一个记录应包含哪些数据项，取决于需要描述对象的哪个方面。例如你的身份是学生，那么可以将（成绩、学号、性别、姓名）四个数据项作为一个记录。

   为了可以唯一标识一个记录，需要在一个记录的各个数据项中确认出一个或几个数据项，把它们的集合称为关键字（key），通常只需要一个数据项，例如学号。

3. 文件

   文件是指由创建者所定义的、具有问价名的一组相关元素的集合，可分为有结构文件和无结构文件两种。在有结构的文件中，文件由若干项相关记录组成，而无结构文件则被看成是一个字符流。文件在文件系统中是一个最大的数据单位，它描述了一个对象集。例如，可以将一个班的学生记录作为一个文件。

   文件属性包括

   - 文件类型。可以从不同角度来规定文件的类型，例如源文件、目标文件以及可执行文件等。
   - 文件长度。文件长度指文件的当前长度吗，长度的单位可以是字节、字或块、也可能是最大允许的长度。
   - 文件的物理位置。该项属性通常用于指示文件所在设备及所在设备中地址的指针。
   - 文件的创建时间。这是指最后一次的修改时间等。

虽然上面给出了结构化的表述，但实际上关于文件并无严格的定义。在操作系统中，通常将程序和数据组织成文件。文件可以是数字、字母或二进制代码，基本访问单位可以是字节、行或记录。文件可以长期存储于硬盘或其他二级存储器中，允许可控制的进程间共享访问，能够被组织成复杂的结构。

### 1.2 文件的属性

文件具有一定的属性，系统不同，属性也会有所不同，但通常都包括如下属性。

1. 名称。文件名称唯一，以容易读取的形式保存。
2. 标识符。标识文件系统内文件的唯一标签，通常为数字，是对人不可读的一种内部名称。
3. 类型。被支持不同类型的文件系统所使用。
4. 位置。指向设备和设备上文件的指针。
5. 大小。文件当前大小（用字节、字或块表示），也可包含文件允许的最大值。
6. 保护。对文件进行保护的访问控制信息。
7. 时间、日期和用户标识。文件创建、上次修改和上次访问的相关信息，用于保护和跟踪文件的使用。

所有文件的信息都保存在目录结构中，而目录结构保存在外存上。文件信息在需要时才调入内存。通常，目录条目包括文件名称及其唯一的标识符，而标识符定位其他属性的信息。

### 1.3 文件的基本操作

文件属于抽象数据类型。为了恰当地定义文件，需要考虑有关文件的操作。操作系统提供系统调用，它对文件进行创建、写、读、重定位、删除和截断等操作。

1. 创建文件。创建文件有两个必要步骤：一是在文件系统中为文件找到空间；二是在目录中为新文件创建条目，该条目记录文件名称、在文件系统中的位置及其他可能的信息。
2. 写文件。为了写文件，执行一个系统调用，指明文件名称和要写入文件的内容。对于给定文件名称，系统搜索目录以查找文件位置。系统必须为该文件维护一个写位置的指针。每当发生写操作时，便更新写指针。
3. 读文件。为了读文件，执行一个系统调用，指明文件名称和要读入文件块的内存位置。同样，需要搜索目录以找到相关目录项，系统维护一个读位置的指针。每当发生读操作时，更新读指针。一个进程通常只对一个文件读或写，因此当前操作位置可作为每个进程当前文件位置的指针。由于读和写操作都使用同一指针，因此节省了空间，也降低了系统复杂度。
4. 文件重定位（文件寻址）。按某条件搜索目录，将当前文件位置设为给定值，并且不会读、写文件。
5. 删除文件。先从目录中找到要删除文件的目录项，使之成为空项，然后回收该文件所占用的存储空间。
6. 截断文件。允许文件所有属性不变，并删除文件内容，即将其长度设为 0 并释放其空间。

这 6 个基本操作可以组合起来执行其他文件操作。例如，一个文件的复制，可以创建新文件、从旧文件读出并写入新文件。

### 1.4 文件的打开与关闭

因为许多文件操作都涉及为给定文件搜索相关目录条目，因此许多系统要求在首次使用文件时，使用系统调用 open 将指明文件的属性（包括该文件在外存上的物理位置）从外存复制到内存打开文件表的一个表目中，并将该表目的编号（也称索引）返回给用户。操作系统维护一个包含所有打开文件信息的表（打开文件表，open-file table）。当用户需要一个文件操作时，可通过该表的一个索引指定文件，因此省略了搜索环节。当文件不再使用时，进程可以关闭它，操作系统从打开文件表中删除这一条目。

大部分操作系统要求在文件使用之前就被显式地打开。操作 open 会根据文件名搜索目录，并将目录条目复制到打开文件表。若调用 open 的请求（创建、只读、读写、添加等）得到允许，则进程就可以打开文件，而 open 通常返回一个指向打开文件表中的一个条目的指针。通过使用该指针（而非文件名）进行所有 I/O 操作，以简化步骤并节省资源。

注意，在 open 调用完成后，操作系统对该文件的任何操作都不再需要文件名，而只需要 open 调用返回的指针。

整个系统表包含进程相关信息，如文件在磁盘的位置、访问日期和大小。一个进程打开一个文件，系统打开文件表就会为打开的文件增加相应条目。当另一个进程执行 open 时，只不过是在其进程打开表中增加一个条目，并指向整个系统表的相应条目。通常，系统打开文件表的每个文件时，还用一个文件打开计数器（Open Count），以记录多少进程打开了该文件。每个关闭操作 close 事 count 递减，当打开计数器为 0 时，表示该文件不再被使用，系统将回收分配给该文件的内存空间等资源。若文件被修改过，则将文件写回外存，并将系统打开文件表中的相应条目删除，最后释放文件的文件控制块（File Control Block，FCB）。

每个打开文件都有如下关联信息：

1. 文件指针。系统跟踪上次的读写位置作为当前文件位置的指针，这种指针对打开文件的某个进程来说是唯一的，因此必须与磁盘文件属性分开保存。
2. 文件打开计数。文件关闭时，操作系统必须重用其打开文件表条目，否则表内空间会不够用。因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件。计数器跟踪打开和关闭的数量，计数为 0 时，系统关闭文件，删除该条目。
3. 文件磁盘位置。绝大多数文件操作都要求系统修改文件数据。该消息保存在内存中，以免为每个操作都从磁盘中读取。
4. 访问权限。每个进程打开文件都需要有一个访问模式（创建、只读、读写、添加等）。该信息保存在进程的打开文件表中，以便操作系统能够允许或拒绝之后的 I/O 请求。

## 2. 文件的逻辑结构

文件的逻辑结构是从用户观点出发看到的文件的组织形式。文件的物理结构（又称文件的存储结构，见 4.2.1）是从实现观点出发看到的文件在外存上的存储组织形式。文件的逻辑结构与存储介质特性无关，但文件的物理结构与存储介质的特性有很大关系。文件的逻辑结构实际上是指在文件的内部，数据逻辑上是如何组织起来的。

按逻辑结构，文件可划分为无结构文件和有结构文件两种。

### 2.1 无结构文件（流式文件）

无结构文件是最简单的文件组织形式。无结构文件将数据按顺序组织成记录并积累、保存，它是有序相关信息项的集合，以字节（Byte）为单位。由于无结构文件没有结构，因而对记录的访问只能通过穷举搜索的方式，故这种文件形式对大多数应用不适用。但字符流的无结构文件管理简单，用户可以方便地对其进行操作。所以，那些对基本信息单位操作不多的文件较适于采用字符流的无结构方式，如原程序文件、目标代码文件等。

### 2.2 有结构文件（记录式文件）

有结构文件按记录的组织形式可以分为如下几种：

1. 顺序文件。文件中的记录一个接一个地顺序排列，记录通常是定长的，可以顺序存储或链表形式存储，在访问时需要顺序搜索文件。顺序文件有以下两种结构：第一种是串结构，记录之间的顺序与关键字无关。通常的办法是由时间决定，即按存入时间的先后排列，最先存入的记录作为第 1 条记录，其次存入的为第 2 条记录，以此类推。第二种是顺序结构，指文件中的所有记录按关键字顺序排列。

   在对记录进行批量操作，即每次要读或写一大批记录时，顺序文件的效率是所有逻辑文件中最高的；此外，也只有顺序文件才能存储在磁带上，并能有效地工作，但顺序文件对查找、修改、增加或删除单条记录的操作比较困难。

2. 索引文件（P220）。对于定长记录文件，要查找第 `i` 条记录，可直接根据 `i×L` 计算得到第 `i` 条记录相对于第 1 条记录的地址。

   然而，对于可变长记录的文件，要查找第 `i` 条记录，必须顺序地查找前 `i-1` 条记录，从而获得相应记录的长度 `L` ，进而按 `ΣLi+i` （`i` 表示每个记录需要 1 个字节记录长度） 计算出第 `i` 条记录的首址。

   变长记录文件只能顺序查找，系统开销较大。为此，可以建立一张索引表以加快检索速度，索引表本身是定长记录的顺序文件。在记录很多或访问要求高的文件中，需要引入索引以提供有效的访问。实际上，通过索引可以成百上千地提高访问速度。

3. 索引顺序文件。索引顺序文件是顺序和索引两种组织形式的结合。索引顺序文件将顺序文件中的所有记录分为若干组，为顺序文件建立一张索引表，在索引表中为每组的第一个记录建立一个索引项，其中含有该记录的关键字值和指向该记录的指针（P220）。

   主文件包含姓名和其他数据项。姓名为关键字，索引表中为每组的第一个记录（不是每条记录）的关键字值，用指针指向主文件中该记录的起始位置。索引表只包含关键字和指针两个数据项，所有姓名关键字递增排列。主文件中记录分组排列，同一个组中的关键字可以无序，但组和组之间的关键字必须有序。查找一条记录时，首先通过索引表找到其所在的组，然后在该组中使用顺序查找，就能很快地找到记录。

   对于含有 N 条记录的顺序文件，查找某关键字值的记录时，平均需要查找 N/2 次。在索引顺序文件中，假设 N 条记录分为 `sqrt(N)` 组，索引表中有 `sqrt(N)` 个表项，每组有 `sqrt(N)` 条记录，在查找某关键字值的记录时，先顺序查找索引表，需要查找 `sqrt(N)/2` 次，然后再主文件中对应的组中顺序查找，也需要查找  `sqrt(N)/2` 次，因此共需查找  `sqrt(N)` 次。显然，索引顺序文件提高了查找效率，若记录数很多，则可采用两级或多级索引。

   索引文件和索引顺序文件都提高了存取的速度，但因为配置索引表而增加了存储空间。

4. 直接文件或散列文件（Hash File）。给定记录的键值或通过散列函数转换的键值直接决定记录的物理地址。这种映射结构不同于顺序文件或索引文件，没有顺序的特性。

   散列文件有很高的存取速度，但是会引起冲突，即不同关键字的散列函数值相同。

若你学了数据结构，会有这样的感觉：有结构文件逻辑上的组织，是为在文件中查找数据服务的（顺序查找、索引查找、索引顺序查找、哈希查找）。

## 3. 目录结构

与文件管理系统和文件集合相关联的是文件目录，它包含有关文件的信息如属性、位置和所有权等。这些信息主要由操作系统进行管理。首先我们来看看目录管理的基本要求：从用户的角度看，目录在用户（应用程序）所需要的文件名和文件之间提供一种映射，所以目录管理要实现 “按名存取”；目录存取的效率直接影响系统的性能，所以要提高对目录的检索速度；在共享系统中，目录还需要提供用于控制访问文件的信息。此外，文件允许重名也是用户的合理和必然要求，目录管理通过树形结构来解决和实现。

前面介绍了文件内部的逻辑结构，下面介绍多个文件之间在逻辑上是如何组织的，这实际上是文件 “外部” 的逻辑结构的问题。

### 3.1 文件控制块和索引结点

与进程管理一样，为实现目录管理，操作系统引入了文件控制块的数据结构。

1. 文件控制块。文件控制块（FCB）是用来存放控制文件需要的各种信息和数据结构，以实现 “按名存取”。FCB 的有序集合称为文件目录，一个 FCB 就是一个文件目录项。为了创建一个新文件，系统将分配一个 FCB 并存放在文件目录项。

   FCB 主要包含以下信息：
   
   1. 基本信息，如文件名、文件的物理位置、文件的逻辑结构、文件的物理结构等。
   2. 存取控制信息，如文件存取权限等。
   3. 使用信息，如文件建立时间、修改时间等。
   
2. 索引结点。在检索目录文件的过程中，只用到了文件名，仅当找到一个目录项（查找文件名与目录项中文件名匹配）时，才需要从该目录项中读出该文件的物理地址。也就是说，在检索目录时，文件的其他描述信息不会用到，也不需要调入内存。因此，有的系统（如 UNIX，P221）采用了文件名和文件描述信息分开的方法，文件描述信息单独形成一个称为索引结点的数据结构，简称 `i` 结点。在文件目录中的每个目录项仅由文件名和指向该文件所对应的 `i` 结点的指针构成。

一个 FCB 的大小是 64B，盘块大小是 1KB，因此在每个盘块中可以存放 16 个 FCB（注意，FCB 必须连续存放）。而在 UNIX 系统中，一个目录项仅占 16 B，其中 14B 是文件名，2B 是 `i` 结点指针。在 1KB 的盘块中可存放 64 个目录项。这样，就可使查找文件时的平均启动磁盘次数减少到原来的 1/4（64/16），大大节省了系统开销。

存放在磁盘上的索引结点称为磁盘索引结点，UNIX 中的每个文件都有一个唯一的磁盘索引结点，主要包括以下几个方面：

1. 文件主标识符，拥有该文件的个人或小组的标识符。
2. 文件类型，也包括普通文件、目录文件或特别文件。
3. 文件存取权限，各类用户对该文件的存取权限。
4. 文件物理地址，每个索引结点中含有 13 个地址项，即 `iaddr(0)~iaddr(12)` ，它们以直接或间接方式给出数据文件所在盘块的编号。
5. 文件长度，以字节为单位。
6. 文件链接计数，在本文件系统中所有指向该文件的文件名的指针计数。
7. 文件存取时间，本文件最近被进程存取的时间、最近被修改的时间及索引结点最近被修改的时间。

文件被打开时，磁盘索引结点复制到内存的索引结点中，以便于使用。在内存索引结点中又增加了以下内容。

1. 索引结点编号，用于标识内存索引结点。
2. 状态，指示 `i` 结点是否上锁或被修改。
3. 访问计数，每当有一进程要访问此 `i` 结点时，计数加 1，访问结束减 1。
4. 逻辑设备号，文件所属文件系统的逻辑设备号。
5. 链接指针，设置分别指向空闲链表和散列队列的指针。

FCB 或索引结点相当于图书馆中图书的索书号，我们可以在图书馆网站上找到图书的索书号，然后根据索书号找到想要的书本。

### 3.2 目录结构

在理解一个文件系统的需求前，我们首先考虑在目录这个层次上所需要执行的操作，这有助于后面文件系统的整体理解。

1. 搜索。当用户使用一个文件时，需要搜索目录，以找到该文件的对应目录项。
2. 创建文件。当创建一个新文件时，需要在目录中增加一个目录项。
3. 删除文件。当删除一个文件时，需要在目录中删除相应的目录项。
4. 显示目录。用户可以请求显示目录的内容，如显示该用户目录中的所有文件及属性。
5. 修改目录。某些文件属性保存在目录中，因而这些属性的变化需要改变相应的目录项。

操作时，考虑以下几种目录结构：

1. 单级目录结构（P222）。在整个文件系统中只建立一张目录表，每个文件占一个目录项。

   当访问一个文件时，先按文件名在该目录中查找到相应的 FCB，经合法性检查后执行相应的操作。当建立一个新文件时，必须先检索所有目录项以确保没有 “重名” 的情况，然后在该目录中增设一项，把 FCB 的全部信息保存在该项中。当删除一个文件时，先从该目录中找到该文件的目录项，回收该文件所占用的存储空间，然后清除该目录项。

   单级目录结构实现了 “按名存取”，但是存在查找速度慢，文件不允许重名、不便于文件共享等缺点，而且对于多用户的操作系统显然是不适用的。

2. 两级目录结构。单级目录结构很容易造成文件名称的混淆，因此可以考虑采用两级方案，将文件目录分成主文件目录（Master File Directory，MFD）和用户文件目录（User File Directory，UFD）两级（P223）。

   主文件目录项记录用户名及相应用户文件目录所在的存储位置。用户文件目录项记录该用户的 FCB 信息。当某用户欲对其文件进行访问时，只需搜索该用户对应的 UFD，这即解决了不同用户文件的 “重名” 问题，又在一定程度上保证了文件的安全。

   两级目录结构可以解决多用户之间的文件重名问题，文件系统可以在目录上实现访问限制。但是两级目录结构缺乏灵活性，不能对文件分类。

3. 多级目录结构（树形目录结构）。将两级目录结构的层次关系加以推广，就形成了多级目录结构，即树形目录结构（P223）。

   用户要访问某个文件时，用文件的路径名称标识文件，文件路径名只是个字符串，由从根目录出发到所找文件通路上所有目录名与数据文件名用分隔符 `/` 链接而成。从根目录出发的路径称为绝对路径。当层次较多时，每次从根目录查询会浪费时间，于是加入了当前目录，进程对各文件的访问都是相对于当前目录进行的。当用户要访问某个文件时，使用相对路径标识文件，相对路径由从当前目录出发到所找文件通路上所有目录名与数据文件名用分隔符 `/` 链接而成。

   Linux 操作系统的目录结构中，`/dev/had` 就是一个绝对路径。若当前目录为 `/bin` ，则 `./ls` 就是一个相对路径，其中符号 `.` 表示当前工作目录。

   通常，每个用户都由各自的 "当前目录"，登录后自动进入该用户的 “当前目录”。操作系统提供一条专门的系统调用，供用户随时改变 “当前目录”。例如，在 UNIX 系统中，`/etc/passwd` 文件就包含有用户登录时默认的 “当前目录”，可用 `cd` 命令改变 “当前目录”。

   树形目录结构可以很方便地对文件进行分类，层次结构清晰，也能够更有效地进行文件的管理和保护。但是，在树形目录中查找一个文件时，需要按路径名逐级访问中间结点，这就增加了磁盘访问次数，无疑将影响查询速度。

4. 无环图目录结构。树形目录结构能便于实现文件分类，但不便于实现文件共享，为此在树形目录结构的基础上增加了一些指向同一结点的有向边，使整个目录成为一个有向无环图。引入无环图目录结构是为了实现文件共享（224）。

   当某用户要求删除一个共享结点时，若系统只是简单地将它删除，则当另一共享用户需要访问时，会因无法找到这个文件而发生错误。为此，可为每个共享结点设置一个共享计数器，每当图中增加对该结点的共享链时，计数器加 1，每当某用户提出删除该结点时，计数器减 1.仅当共享计数器为 0 时，才真正删除该结点，否则仅删除请求用户的共享链。

   共享文件（或目录）不同于文件拷贝（副本）。若有两个文件拷贝，则每个程序员看到的是拷贝而不是原件；然而，若一个文件被修改，则另一个程序员的拷贝不会改变。对于共享文件，只存在一个真正的文件，任何改变都会为其他用户所见。

   无环图目录结构方便地实现了文件的共享，但使得系统的管理变得更加复杂。

## 4. 文件共享

文件共享使多个用户（进程）共享同一个文件，系统中只需保留该文件的一个副本。若系统不能提供共享功能，则每个需要该文件的用户都要有各自的副本，会造成对存储空间的极大浪费。随着计算机技术的发展，文件共享的范围已由单机系统发展到多机系统，进而通过网络扩展到全球。这些文件的分享是通过分布式文件系统、远程文件系统、分布式信息系统实现的。这些系统允许多个客户通过 C/S 模型共享网络中的服务器文件。

现代常用的两种文件共享方法如下。

### 4.1 基于索引结点的共享方式（硬链接）

在树形结构的目录中，当有两个或多个用户要共享一个子目录或文件时，必须将共享文件或子目录链接到两个或多个用户的目录中，才能方便地找到该文件（P224）.

在这种共享方式中，诸如文件的物理地址及其他的文件属性等信息，不再放在目录项中，而是放在索引结点中。在文件目录中只设置文件名及指向相应索引结点的指针。在索引结点中还应有一个链接计数 count，用于表示链接到本索引结点（即文件）上的用户目录项的数目。当 count=2 时，表示有两个用户目录项链接到本文件上，或者说有两个用户共享此文件。

用户 A 创建一个新文件时，它便是该文件的所有者，此时将 count 置为 1。用户 B 要共享此文件时，在用户 B 的目录中增加一个目录项，并设置一个指针指向该文件的索引结点。此时，文件主仍然是用户 A，count=2。用户 A 不再需要此文件，不能将文件直接删除。因为若删除了该文件，则必然也删除了该文件的索引结点，这样便会使用户 B 的指针悬空，而用户 B 可能正在此文件上执行写操作，此时用户 B 会无法访问到文件。因此用户 A 不能删除此文件，只是将该文件的 count 减 1，然后删除自己目录中的相应目录项。用户 B 仍可以使用该文件。当 count=0 时，表示没有用户使用该文件，系统将负责删除该文件（225）。

### 4.2 利用符号链实现文件共享（软链接）

为使用户 B 能共享用户 A 的一个文件 F，可以由系统创建一个 LINK 类型的新文件，也取名为 F，并将文件 F 写入用户 B 的目录中，以实现用户 B 的目录与文件 F 的链接。在新文件中只包含被链接文件 F 的路径名。这样的链接方式被称为符号链接。

新文件中的路径名只被视为符号链，当用户 B 要访问被链接的文件 F 且正要读 LINK 类新文件时，操作系统会根据新文件中的路径名去读文件，从而实现用户 B 对文件 F 的共享。

在利用符号链方式实现文件共享时，只有文件的拥有者才拥有指向其索引结点的指针。而共享该文件的其他用户只有该文件的路径名，并不拥有指向其索引结点的指针。这样，也就不会发生在文件主删除一个共享文件后留下一个悬空指针的情况。当文件的拥有者把一个共享文件删除后，其他用户通过符号链去访问它时，会出现访问失败，于是将符号链删除，此时不会产生任何影响。当然，利用符号链实现文件共享仍然存在问题。例如，一个文件采用符号链方式共享，当文件拥有者将其删除，而在共享的其他用户使用其符号链接访问该文件之前，又有人在同一路径下创建了另一个具有同样名称的文件，则该符号链接将仍然有效，但访问的文件已经改变，从而导致错误。

在符号链的共享方式中，当其他用户读共享文件时，需要根据文件路径名逐个地查找目录，直至找到该文件的索引结点。因此，每次访问时，都可能要多次地读盘，使得访问文件的开销变大并增加了启动磁盘的频率。此外，符号链的索引结点也要耗费一定的磁盘空间。

符号链方式有一个很大的优点，即网络共享只需提供该文件所在机器的网络地址及该机器中的文件路径。

上述两种链接方式都存在一个共同的问题，即每个共享文件都有几个文件名。换言之，每增加一条链接，就增加一个文件名。这实质上是每个用户都使用自己的路径名去访问共享文件。当我们试图去遍历整个文件系统时，将会多次遍历到该共享文件。

硬链接和软链接都是文件系统中的静态共享方法，在文件系统中还存在着另外的共享需求，即两个进程同时对同一个文件进行操作，这样的共享称为动态共享。

可以这样说，文件共享，“软” “硬” 兼施。硬链接就是多个指针指向一个索引结点，保证只要还有一个指针指向索引结点，索引结点就不能删除；软链接就是把到达共享文件的路径记录下来，当要访问文件时，根据路径寻找文件。可以想象，硬链接的查找速度要比软链接的快。

## 5. 文件保护

为了防止文件共享可能会导致文件被破坏或未经核准的用户修改文件，文件系统必须控制用户对文件的存取，即解决对文件的读、写、执行的许可问题。为此，必须在文件系统中建立相应的文件保护机制。

文件保护通过口令保护、加密保护和访问控制等方式实现。其中，口令保护和加密保护是为了防止用户文件被他人存取或窃取、而访问控制则用于控制用户对文件的访问方式。

### 5.1 访问类型

对文件的保护可从限制对文件的访问类型中出发。可加以控制的访问类型主要有以下几种。

1. 读。从文件中读。
2. 写。向文件中写。
3. 执行。将文件装入内存并执行。
4. 添加。将新信息添加到文件结尾部分。
5. 删除。删除文件，释放空间。
6. 列表清单。列出文件名和文件属性。

此外还可以对文件的重命名、复制、编辑等加以控制。这些高层的功能可以通过系统程序调用底层系统调用来实现。保护可以只在底层提供。例如，复制文件可利用一系列的读请求来完成，这样，具有读访问权限的用户同时也就具有了复制和打印权限。

### 5.2 访问控制

解决访问控制最常用的方法是根据用户身份进行控制。而实现基于身份访问的最为普通的方法是，为每个文件和目录增加一个访问控制表（Access-Control List，ACL），以规定每个用户名及其所允许的访问类型。

这种方法的优点是可以使用复杂的访问方法，缺点是长度无法预计并且可能导致复杂的空间管理，使用精简的访问列表可以解决这个问题。

精简的访问列表采用拥有者、组和其他三种用户类型。

1. 拥有者。创建文件的用户。
2. 组。一组需要共享文件且具有类似访问的用户。
3. 其他。系统内的所有其他用户。

这样，只需用三个域即可列出访问表中这三类用户的访问权限。文件拥有者在创建文件时，说明创建者用户名及所在的组名，系统在创建文件时也将文件主的名字、所属组名列在该文件的 FCB 中。用户访问该文件时，按照拥有者所拥有的权限访问文件，若用户和拥有者在同一个用户组，则按照同组权限访问，否则只能按其他用户权限访问。UNIX 操作系统即采用此种方法。

口令和密码是另外两种访问控制方法。

口令指用户在建立一个文件时提供一个口令，系统为其建立 FCB 时附上相应口令，同时告诉允许共享该文件的其他用户。用户请求访问时必须提供相应的口令。这种方法时间和空间的开销不多，缺点是口令直接存在系统内部，不够安全。

密码指用户对文件进行加密，文件被访问时需要使用密钥。这种方法保密性强，节省了存储空间，不过编码和译码要花费一定的时间。

口令和密码都是防止用户文件被他人存取或窃取，并没有控制用户对文件的访问类型。

注意两个问题：

1. 现代操作系统常用的文件保护方法是，将访问控制列表与用户、组和其他成员访问控制方案一起组合使用。
2. 对于多级目录结构而言，不仅需要保护单个文件，而且需要保护子目录内的文件，即需要提供目录保护机制。目录操作与文件操作并不相同，因此需要不同的保护机制。

### 6. 小结

本节开头提出的问题的参考答案如下。

1. 什么是文件？什么是文件系统？

   文件是以计算机硬盘为载体的存储在计算机上的信息集合，它的形式多样，可以是文本文档、图片、程序等。操作系统中负责管理和存储文件信息的软件机构称为文件管理系统，简称文件系统。文件系统由三部分组成：与文件管理有关的软件、被管理文件及实施文件管理所需的数据结构。

2. 文件系统要完成哪些功能？

   对于用户而言，文件系统最主要的功能是实现对文件的基本操作，让用户可以按名存储和查找文件，组织成合适的结构，并应当具有基本的文件共享和文件保护功能。对于操作系统本身而言，文件系统还需要管理与磁盘的信息交换，完成文件逻辑结构和物理结构上的变换，组织文件在磁盘上的存放，采取号的文件排放顺序和磁盘调度方法以提升整个系统的性能。

   现代操作系统的管理思想中，到处能够见到面向对象程序设计的影子。文件实质上就是一个抽象数据类型，也就是一种数据结构：要认识它的逻辑结构、物理结构，以及对这种数据结构的操作。

