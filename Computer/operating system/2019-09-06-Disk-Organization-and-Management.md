---
title: 4.3 Disk Organization and Management
date: 2019-10-13
---

思考以下问题

1. 在磁盘上进行一次读写操作需要哪几部分时间？其中哪部分时间最长？
2. 存储一个文件时，当一个磁道存储不下时，剩下部分是存在同一个盘面的不同磁道好，还是存在同一个柱面上的不同盘面好？

本节内容少，且属于实现部分，要重点掌握计算一次磁盘操作的时间，以及对于给定访盘的磁道序列，按照特定算法求出磁头通过的总磁道数及平均寻道数。

## 1.  磁盘的结构

磁盘（Disk）是由表面涂有磁性物质的金属或塑料构成的圆形盘片，通过一个称为磁头的导体线圈从磁盘存取数据。在读/写操作期间，磁头固定，磁盘在下面高速旋转。（P257）磁盘盘面上的数据存储在一组同心圆中，称为磁道。每个磁道和磁头一样宽，一个盘面有上千个磁道。磁道又划分为几百个扇区，每个扇区固定存储大小（通常为 512B），一个扇区称为一个盘块。相邻磁道及相邻扇区间通过一定的间隙隔开，以避免精度错误。注意，由于扇区按固定圆心角度划分，所以密度从最外道向里道增加，磁盘的存储能力受限于最内道的最大记录密度。

磁盘安装在一个磁盘驱动器中，它由磁头臂、用于旋转磁盘的主轴和用于数据输入/输出的电子设备组成。（P257）多个盘片垂直堆叠，组成磁盘组，每个盘面对应一个磁头，所有磁头固定在一起，与磁盘中心的距离相同且一起移动。所有盘片上相对位置相同的磁道组成柱面。按照这种物理结构组织，扇区就是磁盘可寻址的最小存储单位，磁盘地址用 “柱面号·盘面号·扇区号（或块号）” 表示。

磁盘按不同的方式可分为若干类型：磁头相对于盘片的径向方向固定，称为固定头磁盘，每个磁道一个磁头；磁头可移动的，称为活动头磁盘，磁头臂可来回伸缩定位磁道；磁盘永久固定在磁盘驱动器内的，称为固定盘磁盘；可移动和替换的，称为可换盘磁盘。

前面说过，操作系统中几乎每介绍一类资源及对这类资源的管理时，都要涉及一类调度算法。用户访问文件，需要操作系统的服务，文件实际上存储在磁盘中，操作系统接收用户的命令后，经过一系列的检验访问权限和寻址过程后，最终都会到达磁盘，控制磁盘把相应的数据信息读出或修改。当有多个请求同时到达后，操作系统就要决定先为哪个请求服务，这就是磁盘调度算法要解决的问题。

## 2. 磁盘调度算法

一次磁盘读写操作的时间由寻找（寻道时间）、延迟时间和传输时间决定。

1. 寻道时间 `Ts` 。活动头磁盘在读写信息前，将磁头移动到指定的磁道所需要的时间。这个时间除跨越 n 条磁道的时间外，还包括启动磁臂的时间 `s` ，即 `Ts=m×n+s` ，式中，m 是与磁盘驱动器速度有关的常数，约为 0.2ms，磁臂的启动时间约为 2ms。
2. 延迟时间 `Tr` 。磁头定位到某一磁道的扇区（块号）所需要的时间，设磁盘的旋转速度为 r，则则 `Tr=1/(2r)` 。对于硬盘，典型的旋转速度为 5400 转/分，相当于一周 11.1ms，则 `Tr` 为 5.55ms；对于软盘，其旋转速度为 300~600 转/分，则 `Tr` 为 50~100ms。
3. 传输时间 `Tt` 。从磁盘读出或向磁盘写入数据所经历的时间，这个时间取决于每次所读/写的字节数 b 和磁盘的旋转速度：`Tt=b/(rN)` ，式中，r 为磁盘每秒的转数，N 为一个磁道上的字节数。式中，r 为磁盘每秒的转数，N 为一个磁道上的字节数。

在磁盘存取时间的计算中，寻道时间与磁盘调度算法相关，下面会介绍分析几种算法；而延迟时间和传输时间都与磁盘旋转速度相关，且为线性相关，所以在硬件上，转速是磁盘性能的一个非常重要的参数。

总平均存取时间 `Ta` 可以表示为 `Ta = Ts + 1/(2r) + b/(rN)`

虽然这里给出了总平均存取时间的公式，但是这个平均值是没有太大实际意义的，因为在实际的磁盘 I/O 操作中，存取时间与磁盘调度算法密切相关。调度算法直接决定寻找时间，从而决定总的存取时间。

目前常用的磁盘调度算法有以下几种。

1. 先来先服务（First Come First Served，FCFS）算法

   FCFS 算法根据进程请求访问磁盘的先后顺序进行调度，这是一种最简单的调度算法（P259）。该算法的优点是具有公平性。若只有少量进程需要访问，且大部分请求都是访问簇聚的文件扇区，则有望达到较好的性能；若有大量进程竞争使用磁盘，则这种算法在性能上往往接近于随机调度。所以，实际磁盘调度中会考虑一些更为复杂的调度算法。

   例如，磁盘请求队列中的请求顺序分别为 55，58，39，18，90，160，150，38，184，磁头的初始位置是磁道 100，采用 FCFS 算法时（P259），磁头共移动了

   ```c
   45 + 3 + 19 + 21 + 72 + 70 + 10 + 112 + 146 = 498 个磁道
   ```

   平均寻找长度 = `498/9=55.3` 。

2. 最短寻找时间优先（Shortest Seek Time First，SSTF）算法

   SSTF 算法选择调度处理的磁道是与当前磁头所在磁道距离最近的磁道，以便使每次的寻找时间最短。当然，总是选择最小寻找时间并不能保证平均寻找时间最小，但能提供比 FCFS 算法更好的性能。这种算法会产生 “饥饿” 现象（P259）。若某时刻磁头正在 18 号磁道，而在 18 号磁道附近频繁地增加新的请求，则 SSTF 算法使得磁头长时间在 18 号磁道附近工作，将使 184 号磁道的访问被无限地延迟，即被 “饥饿”。

   例如，磁盘请求队列中的请求顺序分别为 55，58，39，18，90，160，150，38，184，磁头初始位置是磁道 100，采用 SSTF 算法时（P259），磁头共移动了 

   ```c
   10 + 32 + 3 + 16 + 1 +20 + 132 + 10 + 24 =248 个磁道
   ```

   平均寻找长度 = `248/9 = 27.5` 。

3. 扫描（SCAN）算法（又称电梯调度算法）

   SCAN 算法在磁头当前移动方向上选择与当前磁头所在磁道距离最近的请求作为下一次服务的对象，实际上就是在最短寻找时间优先算法的基础上规定了磁头运动的方向（P259）。由于磁头移动规律与电梯运行相似，故又称为电梯调度算法。SCAN 算法对最近扫描过的区域不公平，因此它在访问局部性方面不如 FCFS 算法和 SSTF 算法好。

   例如，磁盘请求队列中的请求顺序分别为 55，58，39，18，90，160，150，38，184，磁头初始位置是磁道 100，采用 SCAN 算法时（P260），不但要知道磁头的当前位置，而且要知道磁头的移动方向，假设沿磁道号增大的顺序移动，则移动磁道的顺序为 100，150，160，184，200，90，58，55，39，38，18.磁头共移动了

   ```c
   50 + 10 + 24 + 16 + 110 + 32 + 3 + 16 + 1 + 20 = 282 个磁道
   ```

   平均寻道长度 = `282/9=31.33` 。

4. 循环扫描（Circular SCAN，C-SCAN）算法

   在扫描算法的基础上规定磁头单向移动来提供服务，回返时直接快速移动至起始端而不服务任何请求。用于 SCAN 算法偏向于处理那些最里或最外的访问请求，所以使用改进型的 C-SCAN 算法来避免这个问题（P260）。

   采用 SCAN 算法和 C-SCAN 算法时，磁头总是严格地遵循从盘里面的一端到另一端，显然，在实际使用时还可以改进，即磁头只需要到达最远端的一个请求即可返回，不需要到达磁盘端点。这种形式的 SCAN 算法和 C-SCAN 算法称为 LOOK 调度（P260） 和 C-LOOK 调度（P260），因为它们在朝一个给定方向移动前会查看是否有请求。

   注意，若无特殊说明，也可以默认 SCAN 算法和 C-SCAN 算法为 LOOK 和 C-OOK 调度。

   例如，磁盘请求队列中的请求顺序分别为 55，58，39，18，90，160，150，38，184，磁头初始位置是磁道 100。采用 C-SCAN 算法时，假设磁头沿磁道号增大的顺序移动（P260），移动磁道的顺序为 100，150，160，184，200，0，18，38，39，55，58，90。磁头共移动

   ```c
   50 + 10 + 24 + 16 + 200 + 18 + 20 + 1 + 16 + 3 + 32 = 390 个磁道
   ```

   平均寻道长度 = `390/9=43.33` 。

   注意区分磁盘调度算法中的循环扫描算法 C-SCAN 和页面调度算法 C-LOCK 算法。

对比以上几种磁盘调度算法，FCFS 算法太过简单，性能较差，仅在请求队列长度接近于 1 时才较为理想；SSTF 算法较为通用和自然；SCAN 算法和 C-SCAN 算法在磁盘负载较大时比较占优势。它们之间的比较如下

|             | 优点                            | 缺点                                           |
| ----------- | ------------------------------- | ---------------------------------------------- |
| FCFS 算法   | 公平、简单                      | 平均寻道距离大，仅应用在磁盘 I/O 较少的场合    |
| SSTF 算法   | 性能比 FCFS 好                  | 不能保证平均寻道时间最短，可能出现 “饥饿” 现象 |
| SCAN 算法   | 寻道性能较好，可避免 “饥饿现象” | 不利于远离磁头一端的访问请求                   |
| C-SCAN 算法 | 消除了对两端磁道请求的不公平    | ---                                            |

除减少寻找时间外，减少延迟时间也是提高磁盘传输效率的重要因素。可以对盘面扇区进行交替编号，对磁盘片组中的不同盘面错位命名（P261）。

磁盘是连续自转设备，磁头读/写一个物理块后，需要经过短暂的处理时间才能开始读/写下一块。假如逻辑记录数据连续存放在磁盘空间中，若在盘面上按扇区交替编号连续存放，则连续读/写多条记录时能减少磁头的延迟时间；同柱面不同盘面的扇区若能错位编号，连续读/写相邻两个盘面的逻辑记录也能减少磁头延迟时间。

（P261）假设每个盘面有 8 个扇区，磁盘片组共 8 个盘面。在随机扇区访问情况下，定位磁道中的一个扇区平均需要转过 4 个扇区，这时，延迟时间是传输时间的 4 倍，这是一种非常低效的存取方式。理想化的情况是不需要定位而直接连续读取扇区，没有延迟时间，这样磁盘数据存取效率可以成倍提高。但由于读取扇区的顺序是不可预测的，所以延迟时间不可避免。

磁盘寻块时间分为三个部分，即寻道时间、延迟时间和传输时间，寻道时间和延迟时间属于 “找” 的时间，凡是 “找” 的时间都可以通过一定的方法削减，但传输时间是磁盘本身性质所决定的，不能通过一定的措施减少。

## 3. 磁盘的管理

### 3.1 磁盘初始化

一个新的磁盘只是一个含有磁性记录材料的空白盘。在磁盘能存储数据之前，它必须分成扇区以便磁盘控制器能进行读和写操作，这个过程称为低级格式化（物理分区）。低级格式化为磁盘的每个扇区采用特别的数据结构。每个扇区的数据结构通常由头、数据区域（通常为 512B 大小）和尾部组成。头部和尾部包含了一些磁盘控制器所使用的信息。

为了使用磁盘存储文件，操作系统还需要将自己的数据结构记录在磁盘上：第一步将磁盘分为由一个或多个柱面组成的分区（即我们熟悉的 C 盘、D 盘等形式的分区），第二步对物理分区进行逻辑格式化（创建文件系统），操作系统将初始的文件系统数据结构存储到磁盘上，这些数据结构包括空闲和已分配的空间及一个初始为空的目录。

### 3.2 引导块

计算机启动时需要运行一个初始化程序（自举程序），它初始化 CPU、寄存器、设备控制器和内存等，接着启动操作系统。为此，该自举程序应找到磁盘上的操作系统内核，装入内存，并转到起始地址，从而开始操作系统的运行。

自举程序通常保存在 ROM 中，为了避免改变自举程序代码而需要改变 ROM 硬件的问题，故只在 ROM 中保留很小的自举装入程序，将完整功能的自举程序保存在磁盘的启动块上，启动块位于磁盘的固定位。拥有启动分区的磁盘称为启动磁盘或系统磁盘。

### 3.3 环块

由于磁盘有移动部件且容错能力弱，因此容易导致一个或多个扇区损坏。部分磁盘甚至从出厂时就有坏扇区。根据所使用的磁盘和控制器，对这些块有多种处理方式。

对于简单磁盘，如电子集成启动器（IDE），坏扇区可手工处理，如 MS-DOS 的 Format 命令执行逻辑格式化时便会扫描磁盘以检查扇区。坏扇区在 FAT 表上会表明，因此程序不会使用。

对于复杂的磁盘，如小型计算机系统接口（SCSI），其控制器维护一个磁盘坏块链表。该链表在出厂前进行低级格式化时就已初始化，并在磁盘的整个使用过程中不断更新。低级格式化将一些块保留作为备用，对操作系统透明。控制器可用备用块来逻辑地替代坏块，这种方式称为扇区备用。

对坏块的处理实质上就是用某种机制，使系统不去使用坏块。坏块属于硬件故障，操作系统是不能修复坏块的。

## 4. 小结

本节开头提出的问题的参考答案如下。

1. 在磁盘上进行一次读写操作需要哪几部分时间？其中哪部分时间最长？

   在磁盘上进行一次读写操作花费的时间由寻道时间、延迟时间和传输时间决定。其中寻道时间是将磁头移动到指定磁道所需要的时间，延迟时间是磁头定位到某一磁道的扇区（块号）所需要的时间，传输时间是从磁盘读出或向磁盘写入数据所经历的时间。一般来说，寻道时间因为要移动磁臂，所以占用时间最长。

2. 存储一个文件时，当一个磁道存储不下时，剩下部分是存在同一个盘面的不同磁道好，还是存在同一个柱面上的不同盘面好？

   上一问已经说到，寻道时间对于一次磁盘访问的影响是最大的，若存在同一个盘面的不同轨道，则磁臂势必要移动，这样会大大增加文件的访问时间，而存在同一个柱面上的不同盘面就不需要移动磁道，所以一般情况下存在同一个柱面的不同盘面更好。