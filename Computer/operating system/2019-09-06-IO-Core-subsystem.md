---
title: 5.2 IO Core subsystem 
date: 2019-10-09
---

思考以下问题

1. 当处理机和外部设备速度差距较大时，并且此时不想让其中一方等待，有什么方法可以解决问题？
2. 什么是设备的独立性？引入设备的独立性有什么好处？

## 1. I/O 子系统概述

由于 I/O 设备种类繁多，功能和传输速率差异巨大，因此需要多种方法来进行设备控制。这些方法共同组成了操作系统内核的 I/O 子系统，它将内核的其他方面从繁重的 I/O 设备管理中解放出来。I/O 核心子系统提供的服务主要有 I/O 调度、缓冲与高速缓存、设备分配与回收、假脱机、设备保护和差错处理等。

## 2. I/O 调度概念

I/O 调度就是确定一个好的顺序来执行这些 I/O 请求。应用程序所发布的系统调用顺序不一定总是最佳选择，所以需要 I/O 调度来改善整体性能，使进程之间公平地共享设备访问，减少 I/O 完成所需要的平均等待时间。

操作系统开发人员通过为每个设备维护一个请求队列来实现调度。当一个应用程序执行阻塞 I/O 系统调用时，该请求就加到相应设备的队列上。I/O 调度会重新安排队列顺序，以改善系统总体效率和应用程序的平均响应时间。

I/O 子系统还可使用主存或磁盘上的存储空间的技术，如缓冲、高速缓存、假脱机等来改善计算机效率。

4.3 节的磁盘调度算法其实就是 I/O 调度的一种。

## 3. 高速缓存与缓冲区

### 3.1 磁盘高速缓存（Disk Cache）

操作系统中使用磁盘高速缓存技术来提高磁盘的 I/O 速度，对高速缓存复制的访问要比原始数据访问更为高效。例如，正在运行的进程的指令既存储在磁盘上，又存储在物理内存上，也被复制到 CPU 的二级和一级高速缓存中。

不过，磁盘高速缓存技术不同于通常意义下的介于 CPU 与内存之间的小容量高速存储器，而是指利用内存中的存储空间来暂存从磁盘中读出的一系列盘块中的信息。因此，磁盘高速缓存逻辑上属于磁盘，物理上则是驻留在内存中的盘块。

高速缓存在内存中分为两种形式，一种是在内存中开辟一个单独的存储空间作为磁盘高速缓存，大小固定；另一种是把未利用的内存空间作为一个缓冲池，供请求分页系统和磁盘 I/O 分时共享。

### 3.2 缓冲区（Buffer）

在设备管理子系统中，引入缓冲区的目的主要如下：

1. 缓和 CPU 与 I/O 设备间速度不匹配的矛盾。
2. 减少对 CPU 的中断频率，放宽对 CPU 中断响应时间的限制。
3. 解决基本数据单元大小（即数据粒度）不匹配的问题。
4. 提高 CPU 和 I/O 设备之间的并行性。

其实现方法如下：

1. 采用硬件缓冲器，当由于成本太高，除一些关键部位外，一般不采用硬件缓冲器。
2. 采用缓冲区（位于内存区域）。

缓冲区有一个特点，即当缓冲区的数据非空时，不能往缓冲区冲入数据，只能从缓冲区把数据传出；当缓冲区为空时，可以往缓冲区冲入数据，但必须把缓冲区充满后，才能从缓冲区把数据传出。

根据系统设置缓冲器的个数，缓冲技术可以分为如下几种：

1. 单缓冲。在设备和处理机之间设置一个缓冲区。设备和处理机交换数据时，先把被交换数据写入缓冲区，然后需要数据的设备或处理机从缓冲区取走数据。（P288）

   在块设备输入时，假定从磁盘把一块数据输入缓冲区的时间为 T，操作系统将该缓冲区中的数据传送到用户区的时间为 M，而 CPU 对这块数据处理的时间为 C。

   在研究各种缓冲技术的每块数据的处理时间中，有一个技巧：假设一种初始状态，然后计算下一次到达相同状态时所需要的时间，就是处理一块数据所需要的时间。在单缓冲中，这种初始状态为：工作区是满的，缓冲区是空的。如题目没有明确说明，一般认为缓冲区的大小和工作区的大小相等。

   我们假设 `T>C` ，从初始状态开始，当工作区数据处理完后，时间为 C，缓冲区还没充满，当缓冲区充满时，经历了 T 时间，停止再冲入数据，然后缓冲区向工作区传送数据，当工作区满了以后，缓冲区的数据同时也为空，用时为 M，到达下一个开始状态，整个过程用时 M+T；若 `T<C` ，同理，整个过程用时为 M+C。所以单缓冲区处理每块数据的用时为 `max(C,T)+M` 。

2. 双缓冲。根据单缓冲的特点，CPU 在传送时间 M 内处于空闲状态，由此引入双缓冲。I/O 设备输入数据时鲜装填到缓冲区 1，在缓冲区 1 填满后才开始填装缓冲区 2，与此同时处理机可以从缓冲区 1 中取出数据放入用户进程处理，当缓冲区 1 中的数据处理完后，若缓冲区 2 已填满，则处理机又从缓冲区 2 中取出数据放入用户进程处理，而 I/O 设备又可以装填缓冲区 1。注意，必须等缓冲区 2 充满才能让处理机从缓冲区 2 取出数据。双缓冲机制提高了处理机和输入设备的并行操作的程度。

   为了研究双缓冲处理一块数据的用时，我们先规定一种初始状态，工作区是空的，其中一个缓冲区是满的，另外一个缓冲区是空的；我们不妨假设缓冲区 1 是空的，缓冲区 2 是满的。（P288）

   我们假设 `T<C+M` ，缓冲区 2 开始向工作区传送数据，缓冲区 1 开始冲入数据，当工作区充满数据后，缓冲区为空，时间为 M，然后工作区开始处理数据，缓冲区 1 继续冲入数据，因为此时只有一个 I/O 设备，所以缓冲区 2 虽然为空，但不能冲入数据。当缓冲区 1 充满数据后，工作区的数据还未处理完毕，时间为 T，当工作区数据处理完毕后，此时工作区为空，缓冲区 1 满，缓冲区 2 为空，达到下一个初始状态，用时 `C+M` 。

   我们再来分析 `T>C+M` 的情况。缓冲区 2 开始向工作区传送数据，缓冲区 1 开始冲入数据，当工作区充满数据并处理完后，用时 C+M，但缓冲区 1 的数据还未充满；当时间为 T 时，缓冲区 1 的数据充满，到达下一个初始状态。

   总结：双缓冲区处理一块数据的用时为 `max(C+M,T)` 。

   若 `M+C<T` ，则可使块设备连续输入；若 `C+M>T` ，则可使 CPU 不必等待设备输入。对于字符设备，若采用行输入方式，则采用双缓冲可使用户在输入第一行后，在 CPU 执行第一行中的命令的同时，用户可继续向第二缓冲区输入下一行数据。而单缓冲情况下则必须等待一行数据被提取完毕才可输入下一行的数据。

   若两台机器之间通信仅配置了单缓冲（P289），则它们在任意时刻都只能实现单方向的数据传输。例如，只允许把数据 A 机传送到 B 机，或从 B 机传送到 A 机，而绝不允许双方同时向对方发送数据。为了实现双向数据传输，必须在两台机器中都设置两个缓冲区，一个用作发送缓冲区，另一个用作接收缓冲区。

3. 循环缓冲。包含多个大小相等的缓冲区，每个缓冲区中有一个链接指针指向下一个缓冲区，最后一个缓冲区指针指向第一个缓冲区，多个缓冲区构成一个环形。

   循环缓冲用于输入/输出时，还需要有两个指针 in 和 out。对输入而言，首先要从设备接收数据到缓冲区中，in 指针指向可以输入数据的第一个缓冲区；当运行进程需要数据时，从循环缓冲区中取一个装满数据的缓冲区，并从此缓冲区中提取数据，out 指针指向可以提取数据的第一个满缓冲区。输出则正好相反。

4. 缓冲池。由多个系统共用的缓冲区组成，缓冲区按其使用状况可以形成三个队列：空缓冲队列、装满输入数据的缓冲队列（输入队列）和装满输出数据的缓冲队列（输出队列）。还应具有 4 种缓冲区：用于收容输入数据的工作缓冲区、用于提取输入数据的工作缓冲区、用于收容输出数据的工作缓冲区及用于提取输出数据的工作缓冲区（P289）。

   当输入进程需要输入数据时，便从空缓冲队列的队首摘下一个空缓冲区，把它作为收容输入工作缓冲区，然后把输入数据输入其中，装满后再将它挂到输入队列队尾。当计算进程需要输入数据时，便从输入队列取得一个缓冲区作为提取输入工作缓冲区，计算进程从中提取数据，数据用完后再将它挂到空缓冲队列尾。当计算进程需要数据数据时，便从空缓冲队列的队首取得一个空缓冲区，作为收容输出工作缓冲区，当其中装满输出数据后，再将它挂到输出队列队尾。当要输出时，由输出进程从输出队列中取得一个装满输出数据的缓冲区，作为提取输出工作缓冲区，当数据提取完后，再将它挂到空缓冲队列的队尾。

   对于循环缓冲和缓冲池，我们只是定性地介绍它们的机理，而不去定量研究它们的平均处理一块数据所需要的时间。而对于单缓冲和双缓冲，我们只要按照上面的模块分析，就可以解决任何计算单缓冲和双缓冲情况下数据块处理时间的问题，以不变应万变。

### 3.3 高速缓存与缓冲区的对比

高速缓存是可以保存数据拷贝的高速存储器，访问高层缓存比访问原始数据更高效，速度更快。高速缓存和缓冲区的对比如下

1. 相同点：都介于高速设备和低速设备之间。

2. 不同点

   存放数据的不同。高速缓存存放的是低速设备上的某些数据的复制数据，即高速缓存上有的，低速设备上面必然有。而缓冲区存放的是低速设备传递给高速设备的数据（或相反），而这些数据在低速设备（或高速设备）上却不一定有备份，这些数据再从缓冲区传送到高速设备（或低速设备）。

   目的不同。高速缓存存放的是高速设备经常要访问的数据，若高速设备要访问的数据不在高速缓存中，则高速缓存就需要访问低速设备。而在缓冲区中，高速设备和低速设备的通信都要经过缓冲区，高速设备永远不会直接去访问低速设备。

## 4. 设备分配与回收

### 4.1 设备分配概述

设备分配是根据用户的 I/O 请求分配所需的设备。分配的总原则是充分发挥设备的使用效率，尽可能地让设备忙碌，又要避免由于不合理的分配方法造成进程死锁。从设备的特性来看，采用下述三种使用方式的设备分别称为独占设备、共享设备和虚拟设备。

1. 独占式使用设备。指在申请设备时，若设备空闲，则将其独占，不再允许其他进程申请使用，一直等到该设备被释放才允许其他进程申请使用。例如，打印机，在使用它打印时，只能独占使用，否则在同一张纸上交替打印不同任务的内容，无法正常阅读。
2. 分时式共享使用设备。独占式使用设备时，设备利用率低，当设备没有独占使用的要求时，可以通过分时共享使用提高利用率。例如，对磁盘设备的 I/O 操作，各进程的每次 I/O 操作，各进程的每次 I/O 操作请求可以通过分时来交替进行。
3. 以 SPOOLing 分时使用外部设备。SPOOLing（Simultaneous Peripheral Operation On-line）技术是在批处理操作系统时代引入的，即假脱机 I/O 技术。这种技术用于对设备的操作，实质上就是对 I/O 操作进行批处理。SPOOLing 技术实质上是一种以空间换时间的技术，而我们熟悉的请求分页系统中的页面调度算法就刚好相反，是以时间换空间的技术。

### 4.2 设备分配的数据结构

设备分配依据的主要数据结构有设备控制表（DCT）、控制器控制表（COCT）、通道控制表（CHCT）和系统设备表（SDT），各数据结构功能如下。

设备控制表（DCT）：我们可以认为，每个设备控制表就表征一个设备，而这个控制表中的表项就是设备的各个属性（P291）。

每个设备都分为机械部件和电子部件两部分，其中负责解析上层传达的命令并控制机械部件运作的是电子部件（控制器），所以每个 DCT 都需要一个表项来表示控制器，即需要一个指向控制器控制表（COCT）的指针，因此 DCT 与 COCT 有一一对应的关系。

前面我们学过 4 种 I/O 控制方式，通道方式显然要比其他几种方式更加优越，因此现代操作系统的 I/O 控制采用的都是通道控制。设备控制器控制设备与内存交换数据，而设备控制器又需要请求通道为它服务，因此每个 COCT（P291）必有一个表项存放指向相应通道控制表（CHCT）（P291）的指针而一个通道可为多个设备控制器服务，因此 CHCT 种必定有一个指针，指向一个表，这个表上的信息传达的是 CHCT 提供服务的那几个设备控制器。CHCT 与 COCT 的关系是一对多的关系。

系统设备表（SDT）：整个系统只有一张 SDT（P291）。它记录已连接到系统中的所有物理设备的情况，每个物理设备占一个表目。

由于在多道程序系统中，进程数多于资源数，会引起资源的竞争，因此要有一套合理的分配原则，主要考虑的因素有：I/O 设备的固有属性、I/O 设备的分配算法、I/O 设备分配的安全性以及 I/O 设备的独立性。

### 4.3 设备分配的策略

1. 设备分配原则。设备分配应根据设备特性、用户要求和系统配置情况。分配的总原则是：既要充分发挥设备的使用效率，又要避免造成进程死锁，还要将用户程序和具体设备隔离开。

2. 设备分配方式。设备分配方式有静态分配和动态分配两种。

   静态分配主要用于对独占设备的分配，它在用户作业开始执行前，由系统一次性分配该作业所要求的全部设备、控制器（如通道等）。一旦分配，这些设备、控制器（和通道）就一直为该作业所占用，直到该作业被撤销。静态分配方式不会出现死锁，但设备的使用效率低。因此，静态分配方式并不符合分配的总原则。

   动态分配在进程执行过程中根据执行需要进行。当进程需要设备时，通过系统调用命令向系统提出设备请求，由系统按照事先规定的策略给进程分配所需要的设备、I/O 控制器，一旦用完，便立即释放。动态分配方式有利于提高设备的利用率，但若分配算法使用不当，则有可能造成进程死锁。

3. 设备分配算法。常用的分配算法有先请求先分配、优先级高者优先等。

   对于独占设备，既可以采用动态分配方式，又可以采用静态分配方式，但往往采用静态分配方式，即在作业执行前，将作业所要用的这一类设备分配给它。共享设备可被多个进程所共享，一般采用动态分配方式，但在每个 I/O 传输的单位时间内只被一个进程所占有，通常采用先请求先分配和优先级高者优先的分配算法。

### 4.4 设备分配的安全性

设备分配的安全性是指设备分配中应防止发生进程死锁。

1. 安全分配方式。每当进程发出 I/O 请求后便进入阻塞态，直到其 I/O 操作完成时才被唤醒。这样，一旦进程已经获得某种设备后便阻塞，不能再请求任何资源，而且在它阻塞时也不保持任何资源。优点是设备分配安全；缺点是 CPU 和 I/O 设备是串行工作的（对同一进程而言）。
2. 不安全分配方式。进程在发出 I/O 请求后继续运行，需要时又发出第二个、第三个 I/O 请求等。仅当进程所请求的设备已被另一个进程占用时，才进入阻塞态。优点是一个进程可同时操作多个设备，从而迅速推进进程，缺点是这种设备分配有可能产生死锁。

### 4.5 逻辑设备名到物理设备名的映射

为了提高设备分配的灵活性和设备的利用率，方便事先 I/O 重定向，引入了设备独立性。设备独立性是指应用程序独立于具体使用的物理设备。

为了实现设备独立性，在应用程序中使用逻辑设备名来请求使用某类设备，在系统中设置一张逻辑设备表（Logical Unit Table，LUT），用来将逻辑设备名映射为物理设备名。LUT 表项包括逻辑设备名、物理设备名和设备驱动程序入口地址；当进程用逻辑设备名来请求分配设备时，系统为它分配相应的物理设备，并在 LUT 中建立一个表项，以后进程再利用逻辑设备名请求 I/O 操作时，系统通过查找 LUT 来寻找相应的物理设备和驱动程序。

在系统中可采取两种方式建立逻辑设备表。

1. 在整个系统中只设置一张 LUT。这样，所有进程的设备分配情况都记录在这张表中，故不允许有相同的逻辑设备名，主要适用于单用户系统。
2. 为每个用户设备一张 LUT，当用户登录时，系统便为该用户建立一个进程，同时也为之建立一张 LUT，并把该表放入进程的 PCB。

## 5. SPOOLing 技术（假脱机技术）

为了缓和 CPU 的高速性与 I/O 设备低速性之间的矛盾，引入了脱机输入/输出技术。该技术利用专门的外围控制机，将低速 I/O 设备上的数据传送到高速磁盘上，或者相反。SPOOLing 的意思是外部设备同时联机操作，又称假脱机输入/输出操作，是操作系统中采用的一项将独占设备改造成共享设备的技术。（P292）

### 5.1 输入井和输出井

输入井和输出井是指在磁盘上开辟出的两个存储区域。输入井模拟脱机输入时的磁盘，用于收容 I/O 设备输入的数据。输出井模拟脱机输出时的磁盘，用于收容用户程序的输出数据。

### 5.2 输入缓冲区和输出缓冲区

输入缓冲区和输出缓冲区是在内存开辟的两个缓冲区。输入缓冲区用于暂存由输入设备送来的数据，以后再传送到输入井。输出缓冲区用于暂存从输出井送来的数据，以后再传送到输出设备。

### 5.3 输入进程和输出进程

输入进程模拟脱机输入时的外围控制机，将用户要求的数据从输入机通过输入缓冲区再送到输入井。当 CPU 需要输入数据时，直接将数据从输入井读入内存。输出进程模拟脱机输出时的外围控制机，把用户要求输出的数据先从内存送到输出井，待输出设备空闲时，再将输出井中的数据经过输出缓冲区送到输出设备。

共享打印机是使用 SPOOLing 技术的一个实例，这项技术已被广泛地用于多用户系统和局域网络。当用户进程请求打印输出时，SPOOLing 系统同意它打印输出，但并不真正立即把打印机分配给该用户进程，而只为它做两件事：

1. 由输出进程在输出井中为之申请一个空间磁盘块区，并将要打印的数据送入其中。
2. 输出进程再为用户进程申请一张空白的用户请求打印表，并将用户的打印要求填入其中，再将该表挂到请求打印队列中。

SPOOLing 系统的主要特点有：提高了 I/O 的速度；将独占设备改造为共享设备；实现了虚拟设备功能。

前面我们提到过 SPOOLing 技术是一种以空间换时间的技术，我们很容易理解它牺牲了空间，因为它开辟了磁盘上的空间作为输入井和输出井，但它又如何节省时间呢？

从前述内容我们了解到，磁盘是一种高速设备，在与内存交换数据的速度优于打印机、键盘、鼠标等中低速设备。试想一下，若没有 SPOOLing 技术，CPU 要向打印机输出要打印的数据，打印机的打印速度比较慢，CPU 就必须迁就打印机，在打印机把数据打印完后才能继续做其他的工作，浪费了 CPU 的不少时间。在 SPOOLing 技术下，CPU 要打印机打印的数据可以先输出到磁盘的输出井中（这个过程由输出进程控制），然后做其他的事情。若打印机此时被占用，则 SPOOLing 系统就会把这个打印请求挂到等待队列上，待打印机有空时再把数据打印出来。向磁盘输出数据的速度比向打印机输出数据的速度快，因此就节省了时间。

## 6. 小结

本节开头提出的问题的参考答案如下：

1. 当处理机和外部设备速度差距较大时，并且此时不想让其中一方等待，有什么方法可以解决问题？

   可以采用缓冲技术来缓解处理机与外部设备速度上的矛盾，即在某块地方（一般为主存）设立一片缓冲区，外部设备与处理机的输入/输出都经过缓冲区，这样外部设备和处理机就都不用互相等待。

2. 什么是设备的独立性？引入设备的独立性有什么好处？

   设备独立性是指用户在编程序时使用的设备与实际设备无关。一个程序应独立于分配给它的某类设备的具体设备，即在用户程序中只标明 I/O 使用的设备类型即可。

   设备独立性有以下几个优点

   1. 方便用户编程。
   2. 使程序运行不受具体机器环境的限制。
   3. 便于程序移植。