---
title: 4.2 Implementation of File System
date: 2019-10-12
---

思考以下问题

1. 在目录中查找某个文件可以使用什么方法？
2. 文件的逻辑结构和物理结构有何区别？单个文件的逻辑结构和物理结构之间是否存在某些制约关系？

## 1. 文件系统层次结构

现代操作系统有很多文件系统类型（如 FAT32、NTFS、ext2、ext3、ext4 等），因此文件系统的层次结构也不尽相同（P236）。

### 1.1 用户调用接口

文件系统为用户提供与文件及目录有关的调用，如新建、打开、读写、关闭、删除文件，建立、删除目录等。此层由若干程序模块组成，每个模块对应一条系统调用，用户发出系统调用时，控制即转入相应的模块。

### 1.2 文件目录系统

文件目录系统的主要功能是管理文件目录，其任务有管理活跃文件目录表、管理读写状态信息表、管理用户进程的打开文件表、管理与组织存储设备上的文件目录结构、调用下一级存取控制模块。

### 1.3 存取控制验证

实现文件保护主要由该级软件完成，它把用户的访问要求与 FCB 中指示的访问控制权限进行比较，以确认访问的合法性。

### 1.4 逻辑文件系统与文件信息缓冲区

逻辑文件系统与文件信息缓冲区的主要功能是，根据文件的逻辑结构将用户要读写的逻辑记录转换成文件逻辑结构内的相应块号。

### 1.5 物理文件系统

物理文件系统的主要功能是把逻辑记录所在的相对块号转换成实际的物理地址。

### 1.6 辅助分配模块

分配模块的主要功能是管理辅存空间，即负责分配辅存空闲空间和回收辅存空间。

### 1.7 设备管理程序模块

设备管理程序模块的主要功能是分配设备、分配设备读写用缓冲区、磁盘调度、启动设备、处理设备中断、释放设备读写缓冲区、释放设备等。

我们可以通过用户请求访问某个文件时发生的一系列事情来辅助记忆文件系统的层次结构。

例如，用户要查看文件 F 中的内容，对操作系统发出命令（操作系统有面向用户的接口），于是就经过了第一层的用户调用接口。

操作系统得到命令后，需要查找目录以查找文件 F 的索引信息，可能是 FCB，也可能是索引结点，经过了第二层文件目录系统。

通过目录找到文件的 FCB 后，需要查看文件 FCB 上的信息，看看那个用户有没有访问该文件的权限，于是经过了存取控制验证模块。

用户通过验证后，就真正开始寻址。操作系统的寻址往往要先得到逻辑地址，再得到物理地址，于是在开始寻址时，操作系统经过逻辑文件系统与文件信息缓冲区，得到了相应文件的内容的逻辑地址。

把逻辑地址转换为物理地址，是在物理文件系统中完成的。

至此为止，寻址就已完成。寻址完成后，我们关心的是找到的这块空间应该如何管理，若要释放这块空间，则任务就交给辅助分配模块，若要把这块空间分配给设备用于输入/输出，则把任务交给设备管理程序模块。

## 2. 目录实现

在读文件前，必须先打开文件。打开文件时，操作系统利用路径名找到相应目录项，目录项中提供了查找文件磁盘块所需要的信息。目录实现的基本方法有线性列表和哈希表两种，要注意目录的实现就是为了查找，因此线性列表实现对应线性查找，哈希表实现对应散列查找。

### 2.1 线性列表

最简单的目录实现方法是使用存储文件名和数据块指针的线性表。创建新文件时，必须首先搜索目录表以确定没有同名的文件存在，然后在目录表后增加一个目录项。删除文件则根据给定的文件名搜索目录表，接着释放分配给它的空间。重用目录项有许多方法：可以将目录项标记为不再使用，或将它加到空间目录项表上，还可以将目录表中的最后一个目录项复制到空闲位置，并降低目录表长度。采用链表结构可以减少删除文件的时间，其优点在于实现简单，不过由于线性表的特殊性，比较费时。

### 2.2 哈希表

哈希表根据文件名得到一个值，并返回一个指向线性列表中元素的指针。这种方法的优点是查找非常迅速，插入和删除也较简单，不过需要一些预备措施来避免冲突。最大的困难是哈希表长度固定以及哈希函数对表长的依赖性。

目录查询是通过在磁盘上反复搜索完成的，需要不断地进行 I/O 操作，开销较大。所以如前所述，为了减少 I/O 操作，把当前使用的文件目录复制到内存，以后要使用该文件时只需在内存中操作，因此降低了磁盘操作次数，提高了系统速度。

### 3. 文件实现

前面说到，文件实际上是一种抽象数据类型，我们要研究它的逻辑结构、物理结构，以及关于它的一系列操作。文件的实现就是研究文件的物理结构，即文件数据在物理存储设备上是如何分布组织的。同一个问题有两个方面的回答：一是文件的分配方式，讲的是对磁盘非空闲块的管理；二是文件存储管理，讲的是对磁盘空闲块的管理。

### 3.1文件分配方式

文件分配对应于文件的物理结构，是指如何为文件分配磁盘块。常用的磁盘空间分配方法有三种：连续分配、链接分配和索引分配。有的系统（如 RDOS 操作系统）对三种方法都支持，但更普遍的是一个系统只支持一种方法。对于本节的内容，读者要注意与文件的逻辑结构区分（类比数据结构的线性表、顺序表和链表，其逻辑结构都是线性表）。

1. 连续分配。连续分配方法要求每个文件在磁盘上占有一组连续的块（P238）.磁盘地址定义了磁盘上的一个线性排序。这种排序使作业访问磁盘时需要的寻道数和寻道时间最小。

   文件的连续分配可以用第一个块的磁盘地址和连续块的数量来定义。若文件长 n 块并从位置 b 开始，则该文件讲占有块 `b,b+1,...,b+n-1` 。一个文件的目录条目包括开始块的地址和该文件所分配区域的长度。

   连续分配支持顺序访问和直接访问。其优点是实现简单、存取速度块。缺点是文件长度不宜动态增加，因为一个文件末尾后的盘块可能已分配给其他文件，一旦需要增加，就需要大量移动盘块。此外，反复增删文件后会产生外部碎片（与内存管理分配方式中的碎片相似），且很难确定一个文件需要的空间大小，因而只适用于长度固定的文件。

2. 链接分配。链接分配采取离散分配的方式，消除了外部碎片，因此显著提高了磁盘空间的利用率；又因为根据文件的当前需求为其分配必需的盘块，当文件动态增长时，可以动态地再为它分配盘块，因此无须事先知道文件的大小。此外，对文件的增、删、改也非常方便。链接分配又可以分为隐式链接和显式链接两种方式。

   隐式链接（P239）中，每个文件对应一个磁盘块的链表；磁盘块分布在磁盘的任何地方，除最后一个盘块外，每个盘块都由指向下一个盘块的指针，这些指针对用户是透明的。目录包括文件第一块的指针和最后一块的指针。

   创建新文件时，目录中增加一个新条目。每个目录项都有一个指向文件首块的指针。该指针初始化为 NULL 以表示空文件，大小字段为 0。写文件会通过空闲空间管理系统找到空闲块，将该块链接到文件的尾部，以便写入。读文件则通过块到块的指针顺序读块。

   隐式链接分配的缺点是无法直接访问盘块，只能通过指针顺序访问文件，且盘块指针会消耗一定的存储空间。隐式链接的稳定性也是一个问题，系统在运行过程中由于软件或硬件错误导致链表中的指针丢失或损坏，会导致文件数据的丢失。

   显式链接是指把用于链接文件各物理块的指针，从每个物理块的块末尾中提取出来，显式地存放在内存的一张链接表中。该表在整个磁盘仅设置一张，每个表项中存放对应块的下一个链接指针，即下一块盘块号。在该表中，凡属于某个文件的第一个盘块号，或每条链的链首指针所对应的盘块号，均作为文件地址被填入相应文件的 PCB 的 “物理地址” 字段。当某文件要查找当前块的下一块地址时，只需找到链接表中对应的位置，即可找到下一块的指针（P239）。由于查找记录的过程是在内存中进行的，因而不仅显著地提高了检索速度，而且大大减少了访问磁盘的次数。由于分配给文件的所有盘块号都放在该表中，故称该表为文件分配表（File Allocation Table，FAT）。

3. 索引分配。链接方式解决了连续分配的外部碎片和文件大小管理问题。但是，链接分配不能有效支持直接访问（FAT 除外）。索引分配解决了这个问题，它把每个文件的所有盘块号都集中放在一起构成索引块（表）（P340）

   每个文件都有其索引块，这是一个磁盘块地址的数组。索引块的第 `i` 个条目指向文件的第 `i` 个块。目录条目包括索引块的地址。要读第 `i` 块，通过索引块的第 `i` 个条目的指针来查找和读入所需的块。

   创建文件时，索引块的所有指针都设为空。首次写入第 `i` 块时，先从空闲空间中取得一个块，再将其地址写到索引块的第 `i` 个条目。索引分配支持直接访问，且没有外部碎片问题。其缺点是由于索引块的分配，增加了系统存储空间的开销。索引块的大小是一个重要的问题，每个文件必须有一个索引块，因此索引块太小就无法支持大文件。可以采用以下机制来处理这个问题。

   1. 链接方案。一个索引块通常为一个磁盘块，因此它本身能直接读写。为了处理大文件，可以将多个索引块链接起来。
   2. 多层索引。多层索引使第一层索引块指向第二层的索引块，第二层索引块再指向文件块。这种方法根据最大文件大小的要求，可以继续到第三层或第四层。例如，4096B 的块，能再索引块中存入 1024 个 4B 的指针。两层索引允许 1048576 个数据块，即允许最大文件为 4GB。
   3. 混合索引。将多种索引分配方式相结合的分配方式。例如，系统即采用直接地址，有采用单级索引分配方式或两级索引分配方式（重点）。

   此外，访问文件需要两次访问外存，首先要读取索引块的内容，然后访问具体的磁盘块，因而降低了文件的存取速度。为了解决这一问题，通常将文件的索引块读入内存的缓冲区中，以加快文件的访问速度。

三种分配方式的比较如下

|          | 访问第 n 条记录         | 优点                                                         | 缺点                                                         |
| -------- | ----------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 连续分配 | 需访问磁盘 1 次         | 顺序存取时速度快，文件定长时可根据文件起始地址及记录长度进行随机访问 | 文件存储要求连续的存储空间，会产生碎片，不利于文件的动态扩充 |
| 链接分配 | 需访问磁盘 n 次         | 可解决外存的碎片问题，提高外存的空间的利用率，动态增长较方便 | 只能按照文件的指针顺序访问，查找效率低，指针信息存放消耗外存空间。 |
| 索引分配 | m 级需要访问磁盘 m+1 次 | 可以随机访问，文件易于增删                                   | 索引表增加存储空间的开销，索引表的查找策略对文件系统效率影响较大 |

### 3.2 文件存储空间管理

1. 文件存储器空间的划分与初始化。一般来说，一个文件存储在一个文件卷中。文件卷可以是物理盘的一部分，也可以是整个物理盘，支持超大型文件的文件卷也可由多个物理盘组成（P241）。

   在一个文件卷中，文件数据信息的空间（文件区）和存放文件控制信息 FCB 的空间（目录区）是分离的。由于存在很多类的文件表示和存放格式，所以现代操作系统中一般都有很多不同的文件管理模块，通过它们可以访问不同格式的逻辑卷中的文件。逻辑卷在提供文件服务前，必须由对应的文件程序进行初始化，划分好目录区和文件区，建立空间空间管理表格及存放逻辑卷信息的超级块。

2. 文件存储器空间管理。文件存储设备分成许多大小相同的物理块，并以块为单位交换信息，因此，文件存储设备的管理实质上是对空闲块的组织和管理，它包括空闲块的组织、分配与回收等问题。

   1. 空闲表法

      空闲表达属于连续分配方式，它与内存的动态分配方式类似，为每个文件分配一块连续的存储空间。系统为外存上的所有空闲区建立一张空闲盘块表，每个空闲区对应于一个空闲表项，其中包括表项序号、该空闲区第一个盘块号、该区的空闲盘块数等信息。再将所有空闲区按其起始盘块号递增的次序排列（P241）。

      空闲盘区的分配与内存的动态分配类似，同样采取首次适应算法、循环首次适应算法等。例如，在系统为某新创建的文件分配空闲盘块时，先顺序地检索空闲盘块表的各表项，直至找到第一个其大小能满足要求的空闲区，再将该盘区分配给用户，同时修改空闲盘块表。

      系统在对用户所释放的存储空间进行回收时，也采取类似于内存回收的方法，既要考虑回收区是否与空闲表中插入点的前区和后区相邻接，对相邻接者予以合并。

   2. 空闲链表法

      将所有的空闲盘区拉成一条空闲链，根据构成链所用的基本元素不同，可把链表分成两种形式：空闲盘块链和空闲盘区链。

      空闲盘块链将磁盘上的所有空闲空间以盘块为单位拉成一条链。当用户因创建文件而请求分配存储空间时，系统从链首开始，依次摘下适当数目的空闲盘块分配给用户。当用户因删除而释放存储空间时，系统将回收的盘块依次插入空闲盘块链的末尾。这种方法的优点是分配和回收一个盘块的过程非常简单，但在为一个文件分配盘块时可能要重复多次操作。

      空闲盘区链将磁盘上的所有空闲盘区（每个盘区可包含若干盘块）拉成一条链。在每个盘区上除含有用于指示下一个空闲盘区的指针外，还应有能指明本盘区大小（盘块数）的信息。分配盘区的方法与内存的动态分区分配类似，通常采用首次适应算法。在回收盘区时，同样也要将回收区与相邻接的空闲盘区合并。

   3. 位示图法

      位示图利用二进制的一位来表示磁盘中一个盘块的使用情况，磁盘上所有的盘块都有一个二进制位与之对应。当其值为 0 时，表示对应的盘块空闲；当其值为 1 时，表示对应的盘块已分配（P242）。

      盘块的分配：

      1. 顺序扫描位示图，从中找出一个或一组其值为 0 的二进制位。

      2. 将找到的一个或一组二进制位，转换成与之对应的盘块号。若找到的其值为 0 的二进制位位于位示图的第 `i`  行，第 `j` 列，则其相应的盘块号应按下式计算（n 代表每行的位数）：

         `b =n(i-1)+j` 

      3. 修改位示图，令 `map[i][j]=1` 。

      盘块的回收：

      1. 将回收盘块的盘块号转换为位示图中的行号和列号。转换公式为

         ```c
         i = (b-1)/n + 1;
         j = (b-1)%n + 1;
         ```

      2. 修改位示图，令 `map[i][j]=0` 。

   4. 成组链接法

      空闲表法和空闲链表法都不适用于大型文件系统，因为这会使空闲表或空闲链表太大。在 UNIX 系统中采用的是成组链接法，这种方法结合了空闲表和空闲链表两种方法，克服了表太大的缺点。其大致思想是：把顺序的 n 个空闲扇区地址保存在第一个空闲扇区内，其后一个空闲扇区内则保存另一顺序空闲扇区的地址，如此继续，直至所有空闲扇区均予以链接。系统只需要保存一个指向第一个空闲扇区的指针（P243）。通过这种方式可以迅速找到大批空闲块地址。

      表示文件存储器空闲空间的 “位向量” 表或第一个成组链块，以及卷中的目录区、文件区划分信息都需要存放在辅存储器中，一般放在卷头位置，在 UNIX 系统中称为超级块。在对卷中的文件进行操作前，超级块需要预先读入系统空闲的主存，并且经常保持主存超级块与辅存卷中超级块中的一致性。

   注意：如无特别提示，这里所使用的位示图法中的行和列都从 1 开始编号。特别注意，若题目中指明从 0 开始编号，则上述计算方法要进行相应调整。

## 4. 小结

本节开头提出的问题的参考答案如下。

1. 在目录中查找某个文件可以使用什么方法？

   可以采用线性列表法或哈希表法。线性列表把文件名组织成一个线性表，查找时依次与线性表中的每个表项进行比较。若把文件名按序排列，则使用折半查找法可以降低平均的查找时间，但建立新文件时会增加维护线性表的开销。哈希表用文件名通过哈希函数得到一个指向文件的指针，这种方法非常迅速，但要注意避免冲突。

2. 文件的逻辑结构和物理结构有何区别？单个文件的逻辑结构和物理结构之间是否存在着某些制约关系？

   文件的逻辑结构是用户可见的结构，即用户使用文件的结构。文件的物理结构是文件在存储器上的组织结构，它表示一个文件在辅存上安置、链接、编目的方法。它和文件的存取方法以及辅存设备的特性等都有密切的联系。单个文件的逻辑结构和物理结构之间虽然**无明显的制约或关联关系**，但是如果物理结构选择不慎，也很难体现出逻辑结构的特点，比如一个逻辑结构是顺序结构，而物理结构是隐式链接结构的文件，即使理论上可以很快找到某条记录的地址，而实际找时仍然需要在磁盘上一块一块地找。