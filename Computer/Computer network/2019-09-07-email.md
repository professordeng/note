---
title: 6.4 email
date: 2019-09-22
---

## 1. 电子邮件系统的组成结构

自从有了因特网，电子邮件就在因特网上流行起来。电子邮件是一种异步通信方式，通信时不需要双方同时在场。电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中的收件人邮箱中，收件人可以随时上网到自己使用的邮件服务器进行读取。

一个电子邮件系统具有三个最主要的组成构件，即用户代理（User Agent）、邮件服务器和电子邮件使用的协议，如 STMP，POP3（或 IMAP）等。

用户代理（UA）：用户与电子邮件系统的接口。用户代理使用户能够通过一个很友好的接口发送和接收邮件，用户代理至少应当具有撰写、显示和邮件处理的功能。通常情况下，用户代理就是一个运行在 PC 上的程序，常见的有 Outlook、Foxmail 和 Thunderbird 等。

邮件服务器：组成电子邮件系统的核心。邮件服务器的功能是发送和接收邮件，同时还要向发信人报告邮件传送的情况（已交付、被拒绝、丢失等）。邮件服务器采用客户/服务器方式工作，但它能够同时充当客户和服务器。例如，当邮件服务器 A 向邮件服务器 B 发送邮件时，A 就作为 STMP 客户，而 B 是 SMTP 服务器；反之，当 B 向 A 发送邮件时，B 就是 SMTP 客户，而 A 就是 SMTP 服务器。

邮件发送协议和读取协议：邮件发送协议用于用户代理向邮件服务器发送邮件或邮件服务器之间发送邮件，通常使用 SMTP；邮件读取协议用于用户代理从邮件服务器读取邮件，如 POP3。注意，SMTP 采用的是 “推”（Push）的通信方式，即在用户代理向邮件服务器发送邮件及在邮件服务器之间发送邮件时，SMTP 客户端主动将邮件 “推” 送到 SMTP 服务器端。而 POP3 采用的是 “拉”（Pull）的通信方式，即用户读取邮件时，用户代理向邮件服务器发出请求，“拉” 取用户邮箱中的邮件。

下面简单介绍电子邮件的收发过程。

1. 发信人调用用户代理来撰写和编辑要发送的邮件。用户代理用 SMTP 把邮件传送给发送方邮件服务器。
2. 发送方邮件服务器将邮件放入邮件缓存队列中，等待发送。
3. 运行在发送方邮件服务器的 SMTP 客户进程，发现邮件缓存中有待发送的邮件，就向运行在接收方邮件服务器的 SMTP 服务器进程发起建立 TCP 连接。
4. TCP 连接建立后，SMTP 客户进程开始向远程 SMTP 服务器进程发送邮箱。当所有待发送邮件发完后，SMTP 就关闭所建立的 TCP 连接。
5. 运行在接收方邮箱服务器中的 SMTP 服务器进程收到邮件后，将邮件放入收信人的用户邮箱，等待收信人在方便时进行读取。
6. 收信人打算收信时，调用用户代理，使用 POP3（或 IMAP）协议将自己的邮件从接收方邮件服务器的用户邮箱中取回（如果邮箱中有来信的话）。

## 2. 电子邮件格式与 MIME

### 2.1 电子邮件格式

一个电子邮件分为信封和内容两大部分，邮件内容又分为首部和主体两部分。RFC 822 规定了邮件的首部格式，而邮件的主体部分则让用户自由撰写。用户写好首部后，邮件系统自动地将信封所需的信息提取出来并写在信封上，用户不需要亲自填写信封上的信息。

邮件内容的首部包含一些首部行，每个首部行由一个关键字后跟冒号再后跟值组成。有些关键字是必需的，有些则是可选的。最重要的关键字是 `To:` 和 `Subjsst:` 。

To 是必需的关键字，后面填入一个或多个收件人的电子邮件地址。电子邮件地址的规定格式为：收件人邮箱名@邮箱所在主机的域名，如 `abc@cskaoyan.com` ，其中收信人邮箱名即用户名，`abc` 在 `cskaoyan.com` 这个邮件服务器上必须是唯一的。这也就保证了 `abc@cskaoyan.com` 这个邮件地址在整个因特网上是唯一的。

Subject 是可选关键字，是邮件的主题，反映了邮件的主要内容。

当然，还有一个必填的关键字是 From，但它通常由邮件系统自动填入。首部与主体之间用一个空行进行分割。典型的邮件内容如下：

```c++
From:hoopdog:hust.edu,cn
To:abc@cskaoyan.com
Subjesct:Say hello to Internet

blahblah...
...
```

### 2.2 多用途网络邮件扩充（MIME）

由于 SMTP 只能传送一定长度的 ASCII 码，许多其他非英语国家的文字（如中文、俄文，甚至待重音符号的法文或德文）就无法传送，且无法传送可执行文件及其他二进制对象，因此提出了多用途网络邮件扩充（Multipurpose Internet Mail Extensions，MIME）。

MIME 并未改动 SMTP 或取代它。MIME 的意图是继续使用目前的格式，但增加了邮件主体的结构，并定义了传送非 ASCII 码的编码规则。也就是说，MIME 邮件可在现有的电子邮件程序和协议下传送。非 ASCII 码的文件通过编码转换为 ASCII 码，然后利用现有架构进行传送即可。

MIME 主要包括以下三部分内容：

1. 5 个新的邮件首部字段，包括 MIME 版本、内容描述、内容标识、内容传送编码和内容类型。
2. 定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化。
3. 定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变。

## 3. SMTP 和 POP3

### 3.1 SMTP

简单邮件传输协议（Simple Mail Transfer Protocol，SMTP）是一种提供可靠且有效的电子邮件传输的协议，它控制两个相互通信的 SMTP 进程交换信息。由于 SMTP 使用客户/服务器方式，因此负责发送邮件的 SMTP 进程就是 SMTP 客户，而负责接收邮件的 SMTP 进程就是 SMTP 服务器。SMTP 用的是 TCP 连接，端口号为 25。SMTP 通信有以下三个阶段。

1. 连接建立

   发件人的邮件发送到发送方邮件服务器的邮件缓存后，SMTP 客户就每隔一定时间对邮件缓存扫描一次。如发现有邮件，就使用 SMTP 的熟知端口号（25）与接收方邮件服务器的 SMTP 服务器建立 TCP 连接。连接建立后，接收方 SMTP 服务器发出 220 Service ready（服务就绪）。然后 SMTP 客户向 SMTP 服务器发送 HELO 命令，附上发送方的主机名。

   SMTP 不使用中间邮件服务器。TCP 连接总是在发送方和接收方这两个邮件服务器之间直接建立，而不管它们相隔多远。接收方的邮件服务器因故障暂时不能建立连接时，发送方的邮件服务器只能等待一段时间后再次尝试连接。

2. 邮件传送

   连接建立后，就可开始传送邮件。邮件的传送从 MAIL 命令开始，MAIL 命令后面有发件人的地址。如 

   ```c++
   MALIL FROM: <hoopdog@hust.edu.cn>
   ```

   若 SMTP 服务器已准备好接收邮件，则回答 `250 OK` 。接着 SMTP 客户端发送一个或多个 RCPT（收件人 recipient 的缩写）命令，格式为 

   ```c++
   RCPT TO:<收件人地址>
   ```

   每发送一个 RCPT 命令，都应有相应的信息从 SMTP 服务器返回，如 `250 OK` 或 `550 No such user here` （无此用户）。

   RCPT 命令的作用是，先弄清接收方系统是否已做好接收邮件的准备，然后才发送邮件，以便不至于发送了很长的邮件后才知道地址错误，进而避免浪费通信资源。

   获取 OK 的回答后，客户端就使用 DATA 命令，表示要开始传输邮件的内容。正常情况下，SMTP 服务器回复信息是 

   ```c++
   354 Start mail input; end with <CRLF>.<CRLF>
   ```

   `<CRLF>` 表示回车换行。此时 SMTP 客户端就可以开始传送邮件内容，并用 `<CRLF>.<CRLF>` （两个回车，中间一个点）表示邮件内容的结束。

3. 连接释放

   邮件发送完毕后，SMTP 客户应发送 QUIT 命令。SMTP 服务器返回的信息是 221（服务关闭），表示 SMTP 同意释放 TCP 连接。邮件传送的全部过程就此结束。

### 3.2 POP3

 邮局协议（Post Office Protocol，POP）是一个非常简单但功能游侠的邮件读取协议，现在使用的是它的第 3 个版本 POP3，POP3 采用的是 “拉” （Pull）的通信方式，当用户读取邮件时，用户代理向邮件服务器发出请求，“拉” 取用户邮箱中的邮件。

POP 也使用客户/服务器的工作方式，在传输层使用 TCP，端口号为 110。在接收方计算机中的用户代理必须允许 POP 客户程序，而在接收方的邮件服务器上则允许 POP 服务器程序。POP 有两种工作方式：“下载并保留” 和 “下载并删除” 。在 “下载并保留” 方式下，用户从邮件服务器上读取邮件后，邮件依然会保存在邮件服务器上，用户可再次从服务器上读取该邮件；而使用 “下载并删除” 方式时，邮件一旦被读取，就被从邮件服务器上删除，用户不能再次从服务器上读取。

另一个邮件接收协议是网际报文存取协议（IMAP），它要比 POP 复杂得多，但目前还只是因特网的建议标准。

此外，随着万维网的流行，目前出现了很多基于万维网的电子邮件，如 Hotmail、Gmail 等。这种电子邮件的特点是，用户浏览器与 Hotmail 或 Gmail 的邮件服务器之间的邮件发送或接收使用的是 HTTP，而仅在不同邮件服务器之间传送邮件时才使用 SMTP。