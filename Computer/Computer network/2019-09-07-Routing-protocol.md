---
title: 4.5 路由协议
date: 2019-11-20
---

## 1. 自治系统

自治系统（Autonomous System，AS）：单一技术管理下的一组路由器，这些路由器使用一种 AS 内部的路由选择协议和共同的度量来确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议来确定分组在 AS 之间的路由。

一个自治系统内的所有网络都由一个行政单位（如一家公司、一所学校、一个政府部门等）管辖，一个自治系统的所有路由器在**本自治系统内都必须是连通的**。

## 2. 域内路由与域间路由

自治系统内部的路由选择称为**域内路由选择**，自治系统之间的路由选择称为域间路由选择。因特网有两大类路由选择协议。

### 2.1 内部网关协议（Interior Gateway Protocol，IGP）

内部网关协议即在一个自治系统内部使用的路由选择协议，它与互联网中其他自治系统选用什么路由选择协议无关。目前这类路由选择协议使用得最多，如 RIP 和 OSPF。

### 2.2 外部网关协议（External Gateway Protocol，EGP）

若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时（两个自治系统可能使用不同的 IGP），就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议（EGP）。目前使用最多的外部网关协议是 BGP-4。

每个自治系统自己决定在本自治系统内部运行哪个内部路由选择协议（例如，可以是 RIP，也可以是 OSPF），但每个自治系统都有一个或多个路由器（下图中的 R1 和 R2）。除运行本系统的内部路由选择协议外，还要运行自治系统间的路由选择协议（如 BGP-4）

```C++
  自治系统A                    自治系统 B
    RIP     R1------------R2    OSPF
                 BGP-4
```

## 3. 路由信息协议（RIP）

路由信息协议（Routing Information Protocol，RIP）是内部网关协议（IGP）中最先得到广泛应用的协议。RIP 是一种分布式的基于距离向量的路由选择协议，其最大优点就是简单。

### 3.1 RIP 规定

1. 网络中的每个路由器都要维护从它自身到其他每个目的网络的距离记录（因此这是一组距离，称为距离向量）
2. 距离也称跳数（Hop Count），规定从一个路由器到直接连接网络的距离（跳数）为 1。而每经过一个路由器，距离（跳数）加 1。
3. RIP 认为好的路由就是它通过的路由器的数目少，即优先选择跳数少的路径。
4. RIP 允许一条路径最多只能包含 15 个路由器（即最多允许 15 跳）。因此距离等于 16 时，它表示网络不可达。可见 RIP **只适用于小型互联网**。距离向量路由**可能会出现环路**的情况，规定路径上的最高跳数的目的是为了防止数据报不断循环在环路上，减少网络拥塞的可能性。
5. RIP 默认在任意两个使用 RIP 的路由器之间每 30 秒广播一次 RIP 路由更新消息，以便自动建立并维护路由表（动态维护）。
6. 在 RIP 中不支持子网掩码的 RIP 广播，所以 **RIP 中每个网络的子网掩码必须相同**。但在新的 RIP2 中，支持变长子网掩码和 CIDR。 

### 3.2 RIP 的特点（注意与 OSPF 的特点比较）

1. 仅和相邻路由器交换信息。
2. 路由器交换的信息是当前路由器所知道的全部信息，即自己的路由表。
3. 按固定的时间间隔交换路由信息，如时隔 30 秒。

RIP 通过距离向量算法来完成路由表的更新。最初，每个路由器只知道与自己直接相连的网络。通过每 30 秒的 RIP 广播，相邻两个路由器相互将自己的路由表发给对方。于是经过第一次 RIP 广播，每个路由器就知道了与自己相邻的路由器的路由表（即知道了距离自己跳数为 1 的网络的路由）。同理，经过第二次 RIP 广播，每个路由器就知道了距离自己跳数为 2 的网络的路由…… 因此经过若干 RIP 广播后，所有路由器都最终知道了整个 IP 网络的路由表，成为 RIP 最终是收敛的。通过 RIP 收敛后，每个路由器到每个目标网络的路由都是距离最短的（即跳数最少，最短路由），哪怕还存在另一条高速（低时延）但路由器较多的路由。

### 3.3 距离向量算法

每个路由表项目都有三个关键数据：`<目的网络 N, 距离 d，下一跳路由器 X>` 。对于每个相邻路由器发送过来的 RIP 报文，执行如下步骤：

1. 对地址为 X 的相邻路由器发来的 RIP 报文，先修改此报文中的所有项目：把 “下一跳” 字段中的地址都改为 X，并把所有的 “距离” 字段的值加 1。
2. 对修改后的 RIP 报文中的每个项目，执行如下步骤：
   1. 当原来的路由表中没有目的网络 N 时，把该网络添加到路由表中。
   2. 当原来的路由表中有目的网络 N ，且下一跳路由地址是 X 时，用收到的项目替换原路由表中的项目。
   3. 当原来的路由表中有目的网络 N，且下一跳路由器的地址不是 X 时，如果收到的项目中的距离 d 小于路由表中的距离，那么就用收到的项目替换原路由表中的项目；否则什么也不做。
3. 如果 180 秒（RIP 默认超时时间为 180 秒）还没有收到相邻路由器的更新路由表，那么把此相邻路由器记为不可达路由器，即把距离设置为 16（距离为 16 表示不可达）。
4. 返回

RIP 最大的优点是实现简单、开销小，收敛过程较快。RIP 的缺点如下：

1. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）
2. 路由器之间交换的是路由器中的完整路由表，因此网络规模越大，开销也越大。
3. 网络出现故障时，会出现**慢收敛**现象（即需要较长时间才能将此信息传送到所有路由器），俗称 “坏消息传得慢”，使更新过程的收敛时间长。

RIP 是应用层协议，它使用 UDP 传送数据（端口 520）。RIP 选择的路径**不一定是时间最短**的，但一定是具有最少路由器的路径。因为它是根据最少的跳数进行路径选择的。

## 4. 开放最短路径优先（OSPF）协议

### 4.1 OSPF 协议的基本特点

开放最短路径优先（OSPF）协议是**使用分布式链路状态路由算法**的典型代表，也是内部网关协议（IGP）的一种。OSPF 与 RIP 相比有以下 4 点主要区别：

1. OSPF 向本自治系统中的所有路由器发送信息，这里使用的方法是**洪泛法**。而 RIP 仅向自己相邻的几个路由器发送信息。
2. 发送的信息是**与本路由器相邻的所有路由器的链路状态**，但这只是路由器所知道的部分信息。“链路状态” 说明本路由器和哪些路由器相邻及该链路的 “度量”（或代价）。而在 RIP 中，发送的信息是本路由器所知道的全部信息，即整个路由表。
3. 只有当链路状态发送变化时，路由器才用洪泛法向所有路由器发送此信息，并且更新过程收敛得快，不会出现 RIP “坏消息传得慢” 的问题。而在 RIP 中，不管网络拓扑是否发生变化，路由器之间都会定期交换路由表的信息。
4. OSPF 是**网络层**协议，它不使用 UDP 或 TCP，而**直接用 IP 数据报传送**（其 IP 数据报首部的协议字段为 89）.而 RIP 是应用层协议，它在传输层使用 UDP。

除以上区别外，OSPF 还有以下特点：

1. OSPF 对不同的链路可根据 IP 分组的不同服务类型（TOS）而设置成**不同的代价**（最短的定义）。因此，OSPF 对于不同类型的业务可计算出不同的路由，十分灵活。
2. 如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这称为**多路径间的负载平衡**。
3. 所有在 OSPF 路由器之间交换的分组都具有**鉴别功能**，因而保证了仅在可信赖的路由器之间交换链路状态信息。
4. 支持可变长度的子网划分和无分类编址 CIDR。
5. 每个链路状态都带上一个 32 位的序号，序号越大，状态就越新。

### 4.2 OSPF 的基本工作原理

由于各路由之间频繁地交换链路状态信息，因此所有路由器**最终**都能建立一个链路状态数据库。这个数据库实际上就是全网的拓扑结构图，它在全网范围内是一致的（称为链路状态数据库的同步）。然后，每个路由器根据这个全网拓扑结构图，使用 **Dijkstra 最短路径算法**计算从自己到各目的网络的最优路径，以此构造自己的路由表。此后，当链路状态发生变化时，每个路由器重新计算到各目的网络的最优路径，构造新的路由表。

注意：虽然使用 Dijkstra 算法能计算出完整的最优路径，但路由表中不会存储完整路径，而**只存储 “下一跳”** （只有到了下一跳路由器，才能知道再下一跳应当怎样走）。

为使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，称为区域。划分区域的好处是，将利用洪泛法交换链路状态信息的范围局限于每个区域而非整个自治系统，减少了整个网络上的通信量。在一个**区域内部的路由器只知道本区域的完整网络拓扑**，而不知道其他区域的网络拓扑情况。这些区域也有层次之分。处在上层的域称为主干区域，负载连通其他下层的区域，并且还连接其他自治域。

### 4.3 OSPF 的五种分组类型

OSPF 共有以下五种分组类型：

1. 问候分组，用来发现和维持邻站的可达性。
2. 数据库描述分组，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
3. 链路状态请求分组，向对方请求发送某些链路状态项目的详细信息。
4. 链路状态更新分组，用洪泛法对全网更新链路状态。
5. 链路状态确认分组，对链路更新分组的确认。

通常每隔 10 秒，每两个相邻路由器要交换一次问候分组，以便知道哪些站可达。在路由器刚开始工作时，OSPF 让每个路由器使用数据库描述分组和相邻路由器交换本数据库中已有的链路状态摘要信息。然后，路由器使用链路状态请求分组，向对方请求发送自己**所缺少的某些链路状态项目的详细信息**。经过一系列的这种分组交换，就建立了全网同步的链路数据库。

```c++
             R1                  R2
确定可达性         问候---------->
                 <-----------问候
达到数据库的同步    数据库描述------>
                 <---- 数据库描述
                 数据库描述------>
                 <-----数据库描述
新情况下的同步      链路状态请求---->
                 <----链路状态更新
                 链路状态确认---->
```

在网络运行的过程中，只要一个路由器的链路状态发生变化，该路由器就要使用**链路状态更新分组**，用洪泛法向全网更新链路状态。其他路由器在更新后，发送**链路状态确认分组**对更新分组进行确认。

为了确保链路状态数据库与全网的状态保持一致，OSPF 还规定每隔一段时间（如 30 分钟）就刷新一次数据库中的链路状态。由于一个路由器的链路状态只涉及与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此，当互联网规模很大时，OSPF 要比 RIP 好得多，而且 OSPF 协议没有 “坏消息传播得慢” 的问题。

注意：教材上说 OSPF 协议不使用 UDP 数据报传送，而是直接使用 IP 数据报传送，在此解释一下什么称为用 UDP 传送，什么称为用 IP 数据报传送。用 UDP 传送是指将**该信息作为 UDP 报文的数据部分**，而直接使用 IP 数据报传送是指**将该信息直接作为 IP 数据报的数据部分**。RIP 报文是作为 UDP 数据报的数据部分。

## 5. 边界网关协议（BGP）

边界网关协议（Border Gateway Protocol，BGP）是不同自治系统的路由器之间交换路由信息的协议，是一种外部网关协议。边界网关协议常用于互联网的网关之间。路由表包含**已知路由器的列表**、路由器能够达到的地址及到达每个路由器的路径的跳数。

内部网关协议主要**设法使数据报在一个 AS 中尽可能有效地从源站传送到目的站**。在一个 AS 内部不需要考虑其他方面的策略。然而 BGP 使用的环境却不同，主要原因如下：

1. 因特网的规模太大，使得自治系统之间路由选择非常困难。
2. 对于自治系统之间的路由选择，要寻址最佳路由是很不现实的。
3. 自治系统之间的路由选择必须考虑有关策略。

边界网关协议（BGP）只能**力求寻找一条能够到达目的网络且比较好的路由**（不能兜圈子），而并非寻找一条最佳路由。BGP 采用的是**路径向量路由选择协议**，它与距离向量协议和链路状态协议有很大的区别。BGP 是应用层协议，它是基于 TCP 的。

BGP 的工作原理如下：每个自治系统的管理员要选择**至少一个路由器**（可以有多个）作为该自治系统的 “BGP发言人”。一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接（可见 BGP 报文是通过 TCP 传送的，也就是说 BGP 报文是 TCP 报文的数据部分），然后在此连接上交换 BGP 报文以建立 BGP 会话，再**利用 BGP 会话交换路由信息**。当所有 BGP 发言人都相互交换网络可达性的信息后，各 BGP 发言人就可找出到达各个自治系统的较好路由。

每个 BGP 发言人除必须允许 BGP 外，还必须运行该 AS 所用的内部网关协议，如 OSPF 或 RIP。BGP 所交换的网络可达性信息就是要达到某个网络（用网络前缀表示）所要经过的一系列 AS。

```c++
自治系统 AS2 的 BGP 发言人通知主干网的 BGP 发言人：要到达网络 N1,N2,N3 和 N4 可经过 AS2
                          
                        /------->本地 ISP(AS4) N1,N2
主干网(AS1)--->地区 ISP(AS2)
                        \------->本地 ISP(AS5) N3,N4
                        
主干网还可发出通知：要到达网络 N5，N6 和 N7 可沿路径 (AS1，AS3) 。
                        /------->本地 ISP(AS6) N5
主干网(AS1)--->地区 ISP(AS3)
                        \------->本地 ISP(AS7) N6,N7
```

BGP 的特点如下：

1. BGP 交换路由信息的结点数量级是自治系统的数量级，要比这些自治系统中的网络数少很多。
2. 每个自治系统中 BGP 发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的路由选择不致过分复杂。
3. BGP 支持 CIDR，因此 BGP 的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。
4. 在 BGP 刚运行时，BGP 的邻站交换整个 BGP 路由表，但以后只需在发生变化时更新有变化的部分。这样做对节省网络带宽和减少路由器的处理开销都有好处。

BGP-4 共使用 4 种报文：

1. 打开（Open）报文。用来与相邻的另一个 BGP 发言人建立关系。
2. 更新（Update）报文。用来发送某一路由的信息，以及列出要撤销的多条路由。
3. 保活（Keepalive）报文。用来确保打开报文并周期性地证实邻站关系。
4. 通知（Notification）报文。用来发送检测到的差错。

RIP、OSPF 和 BGP 的比较如下

| 协议     | RIP                                        | OSPF                                 | BGP                                        |
| -------- | ------------------------------------------ | ------------------------------------ | ------------------------------------------ |
| 类型     | 内部                                       | 内部                                 | 外部                                       |
| 路由算法 | 距离-向量                                  | 链路状态                             | 路径-向量                                  |
| 传递协议 | UDP                                        | IP                                   | TCP                                        |
| 路径选择 | 跳数最少                                   | 代价最低                             | 较好，非最佳                               |
| 交换结点 | 和本结点相邻的路由器                       | 网络中的所有路由器                   | 和本结点相邻的路由器                       |
| 交换内容 | 当前本路由器知道的全部信息，即自己的路由表 | 与本路由器相邻的所有路由器的链路状态 | 首次（整个路由表）；非首次（有辩护的部分） |

## 6. 习题

1. 路由选择协议的功能
2. 吓一跳路由器的理解
3. 路由收敛的含义
4. OSPF 协议根据什么分组来保持与其 neighbor 的连接
5. BGP 可达信息是
6. 路由表的设计
7. TTL

## 7. 习题答案

1. 交换网络状态或通路信息，选择到达目的地的最佳路径，更新路由表。注意发现下一跳的物理地址属于 ARP 协议。
2. 说明是否相连的意思，是可逆的
3. 网络设备的路由表与网络拓扑结构保持一致
4. Hello 分组
5. 到达某个网络所经过的路径。
6. 目的网络 + 下一跳 + 接口（要考虑路由聚合）
7. 默认值为 64，每经过一个路由器就减 1。