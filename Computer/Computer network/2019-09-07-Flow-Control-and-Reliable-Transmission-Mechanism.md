---
title: 3.4 流量控制与可靠传输机制
date: 2019-11-10
---

## 1. 流量控制、可靠传输与滑动窗口机制

流量控制涉及对链路上的帧的发送速率的控制，以使接收方有足够的缓冲空间来接收每个帧。例如，在面向帧的自动重传请求系统中，当待确认帧的数量增加时，有可能超出缓冲存储空间而造成过载。**流量控制的基本方法是由接收方控制发送方发送数据的速率**，常见的方式有两种：**停止-等待协议**和**滑动窗口协议**。

### 1.1 停止-等待流量控制基本原理

发送方每发送一帧，都要等待接收方的应答信号，之后才能发送下一帧；接收方每接收一帧，都要反馈一个应答信号，表示可接收下一帧，如果接收方不反馈应答信号，那么发送方必须一直等待。每次只允许发送一帧，然后就陷入等待接收方确认信息的过程中，因而**传输效率很低**。

### 1.2 滑动窗口流量控制基本原理

在任意时刻，发送方都维持一组连续的允许发送的帧的序号，称为发送窗口；同时接收方也维持一组连续的允许接收帧的序号，称为接收窗口。发送窗口用来对发送方进行流量控制，而发送窗口的大小 WT 代表在还未收到对方确认信息的情况下发送方最多还可以发送多少个数据帧。同理，在接收端设置接收窗口是为了控制可以接收哪些数据帧和不可以接收哪些帧，在接收方，只有收到的数据帧的序号落入接收窗口时，才允许将该数据帧收下。**若接收到的数据帧落在接收窗口之外，则一律将其丢弃**。

发送端每收到一个确认帧，发送窗口就向前滑动一个帧的位置，当发送窗口内没有没有可以发送的帧（**即窗口内的帧全部是已发送但未收到确认的帧**）时，发送方就会停止发送，直到收到接收方发送的确认帧使窗口移动，窗口内有可以发送的帧后，才开始继续发送。

接收端收到数据帧后，将窗口向前移一个位置，并发回确认帧，若收到的数据帧落在接收窗口之外，则一律丢弃。

滑动窗口有以下重要特性：

1. 只有接收窗口向前滑动（同时接收方发送了确认帧）时，发送窗口才有可能（只有发送方收到确认帧后才一定）向前滑动。

2. 从滑动窗口的概念看，**停止-等待协议**、**后退 N 帧协议**和**选择重传协议**只在发送窗口大小于接收窗口大小上有所差别。

   停止-等待协议：发送窗口大小 = 1，接收窗口大小 = 1

   后退 N 帧协议：发送窗口大小 > 1，接收窗口大小 = 1

   选择重传协议： 发送窗口大小 > 1，接收窗口大小 > 1

3. 接收窗口的大小为 1 时，可保证帧的有序接收。

4. 数据链路层的滑动窗口协议中，**窗口的大小在传输过程中是固定的**（注意与传输层的滑动窗口协议的区别）。

### 1.3 可靠传输机制

数据链路层的可靠传输通常使用**确认和超时重传**两种机制来完成。**确认是一种无数据的控制帧**，这种控制帧使得接收方可以让发送方知道哪些内容被正确接收。有些情况下为了提高传输效率，将确认捎带在一个回复帧中，称为**捎带确认**。超时重传是指接收方在发送某个数据帧后就开启一个计时器，在一定时间内如果没有得到发送的数据帧的确认帧，那么就重新发送该数据帧，直到发送成功为止。

**自动重传请求**（Auto Repeat reQuest，ARQ）通过接收方请求发送方重传出错的数据帧来恢复出错的帧，是通信中用于处理信道所带来差错的方法之一。传统自动重传请求分为三种：即**停止-等待**（Stop-and-Wait）ARQ、**后退 N 帧**（Go-Back-N）ARQ 和**选择性重传**（Selective Repeat）ARQ 。后两种协议是**滑动窗口技术与请求重发技术的结合**，由于窗口尺寸开到足够大时，帧在线路上可以连续的流动，因此又称其为**连续 ARQ 协议**。注意，在数据链路层中**流量控制机制和可靠传输机制是交织在一起的**。

## 2. 单帧滑动窗口与停止-等待协议

在停止-等待协议中，源站发送单个帧后必须等待确认，在目的站的回答到达源站之前，源站不能发送其他的数据帧。从滑动窗口机制的角度看，停止-等待协议相当于发送窗口和接收窗口大小均为 1 的滑动窗口协议。

在停止-等待协议中，除数据帧丢失外，还可能出现以下两种差错。

**到达目的站的帧可能已遭破坏**，接收站利用前面讨论过的差错检测技术检出后，简单地将该帧丢弃。为了对付这种可能发生的情况，源站装备了计时器。在一个帧发送之后，源站等待确认，如果在计时器计满时仍未收到确认，那么再次发送相同的帧。如此重复，直到该数据帧无错误地达到为止。

另一种可能的差错是**数据帧正确而确认帧被破坏**，此时接收方已收到正确的数据帧，但发送方收不到确认帧，因此发送方会重传已被接收的数据帧，接收方收到同样的数据帧时会丢弃该帧，并重传一个该帧对应的确认帧。发送的帧交替地用 0 和 1 来识别，肯定确认分别用 ACK0 和 ACK1 来表示，**收到的确认有误时，重传已发送的帧**。停止-等待协议算法的实现步骤如下。

在发送结点：

1. 从主机取一个数据帧，送交发送缓存。

2. V(S) ← 0。{发送状态变量 V(S) 初始化}

3. N(S)←V(S)。{将发送状态变量值写入数据帧中的发送序号 N(S)}

4. 将发送缓存中的数据帧发送出去。{这个数据帧的副本仍保留在发送缓存中}

5. 设置超时计时器。{选择适当的超时重传时间 t(out)}

6. 等待。{等待以下 7 和 8 这两个事件中最先出现的一个}

7. 收到确认帧 `ACKn` 后

   若 n=1-V(S)，则{已发送的数据帧被接收方确认}

   从主机取出一个新的数据帧，放入发送缓存。

   V(S)←[1-V(S)]，转到 4 。{更新发送状态变量，变为下一个序号}

   否则，丢弃这个确认帧，转向 6。{表明已发送的数据帧未被接收方确认}

8. 若超时计时器时间到，则转到 4。（重传已发送的数据帧）

在接收结点：

1. V(R)←0 。{接收状态变量初始化，其数值等于欲接收的数据帧的发送序号}
2. 等待
3. 收到一个数据帧时，检查有无产生传输差错（如用 CRC）
4. 若 N(S)=V(R)，则执行后续算法。{收到发送序号正确的数据帧}
5. 将受到的数据帧的数据部分送交主机。
6. V(R)←[1-V(R)]。{更新接收状态变量，准备接收下一个数据帧}
7. 发送确认帧 `ACKn` ，并转到 2 ，{n=V(R)，表明期望收到 V(R)}

由以上算法可知，对于停止-等待协议，由于每发送一个数据帧就停止并等待，因此用 1bit 来编号就已足够。在停止-等待协议中，若连续出现相同发送序号的数据帧，表明发送端进行了超时重传。连续出现相同序号的确认帧时，表明接收端收到了重复帧。

此外，为了超时重发和判定重发帧的需要，发送方和接收方都须设置一个帧缓冲区。发送端在发送完数据帧时，必须在其发送缓存中保留此数据帧的副本，这样才能在出差错时进行重传。只有在收到对方发来的确认帧 ACK 时，方可清除此副本。

停止-等待协议通信信道的利用率很低。为了克服这一缺点，就产生了另外两种协议，即后退 N 帧协议和选择重传协议。

## 3. 多帧滑动窗口与后退 N 帧协议（GBN）

在后退 N 帧式 ARQ 中，发送方无须在收到上一帧的 ACK 后才能开始发送下一帧，而是可以连续发送帧。当接收方检测出失序的信息帧后，**要求发送方重发最后一个正确接收的信息帧之后的所有未被确认的帧**；或者当发送方发送了 N 个帧后，若发现该 N 个帧的前一个帧在计时器超时后仍未返回其确认信息，则该帧被判为出错或丢失，此时发送方就**不得不重发该出错帧及随后的 N 个帧**，换句话说，**接收方只允许按顺序接收帧**。

源站每发送完一帧就要为该帧设置超时计时器。由于连续发送了许多帧，所以确认帧必须要指明是对哪一帧进行了确认。为了减少开销，**GBN 协议还规定接收端不一定每收到一个正确的数据帧就必须立即发回一个确认帧**，而可以在连续收到好几个正确的数据帧后，**才对最后一个数据帧发确认信息**，或者可在自己有数据要发送时才将对以前正确收到的帧加以捎带确认。这就是说，**对某一数据帧的确认就表明该数据帧和此前所有的数据帧均已正确无误地收到**。

如果 n 号帧出错了，即使之后的帧均正确，但也要丢弃，**丢弃的同时应重复发送最后一个确认帧** `ACK(n-1)` （为了防止已发送的确认帧 `ACK(n-1)` 丢失）。

后退 N 帧协议的接收窗口为 1，可以保证按序接收数据帧。若采用 n 比特对帧编号，则其发送窗口的尺寸 WT 应满足 1≤MT≤2^n-1 。若发送窗口的尺寸大于 2^n-1 ，则会造成接收方无法分辨新帧和旧帧 。（MT=2^n-1 是上限，空出一个是为了**区分全部成功和全部重复的情况**）

后退 N 帧协议一方面因连续发送数据帧而提高了信道的利用率，另一方面在重传时又必须把原来已传送正确的数据帧进行重传（仅因这些数据帧的前面有一个数据帧出了错），这种做法又使传送效率降低。由此可见，**若信道的传输质量很差导致误码率较大时，后退 N 帧协议不一定优于停止-等待协议**。 

## 4. 多帧滑动窗口与选择重发协议（SR）

为进一步提高信道的利用率，可设法**只重传出现差错的数据帧或计时器超时的数据帧**，但此时必须加大接收窗口，以便先收下发送序号不连续但仍处在接收窗口中的那些数据帧。等到所缺序号的数据帧收到后再一并送交主机。这就是**选择重传 ARQ 协议**。

在选择重传协议中，每个发送缓冲区对应一个计时器，当计时器超时时，缓冲区的帧就会重传。另外，该协议使用了比上述其他协议**更有效的差错处理策略**，即一旦接收方怀疑帧出错，就会**发一个否定帧 NAK 给发送方**，要求发送方对 NAK 中指定的帧进行重传。选择重传协议的接收窗口尺寸 WR 和发送窗口尺寸 WT 都大于 1，一次可以发送或接收多个帧。若采用 n 比特对帧编号，为了保证接收方向前移动窗口后，新窗口序号与旧窗口序号没有重叠部分，需要满足**条件**：接收窗口 WR + 发送窗口 WT ≤2^n 。假定仍然采用累计确认的方法，并且**接收窗口 WR  显然不应超过发送窗口 WT**（否则多出来的也没啥用），那么接收窗口尺寸不应超过序号范围的一半，即 WR≤2^(n-1) 。接收窗口为最大值时，WT=WR=2^(n-1)。需要注意的是：一般情况下，**在 SR 协议中，接收窗口的大小和发送窗口的大小是相同的**。

选择重传协议可以避免重复传送那些本已正确达到接收端的数据帧，但在**接收端要设置具有相当容量的缓冲区**来暂存那些未按序正确收到的帧。**接收端不能接收窗口下界以下或上界以上的序号的帧**，因此所需缓冲区的数目等于窗口的大小，而不是序号数目。

信道的效率，也称信道利用率。可从不同的角度来定义信道的效率，这里给出一种从时间角度的定义：**信道效率是对发送方而言的，是指发送方在一个发送周期的时间内，有效地发送数据所需要的时间占整个发送周期的比率**。

例如，发送方从开始发送数据到收到第一个确认帧为止，称为一个发送周期，设为 T，发送方在这个周期内共发送 L 比特的数据，发送方的数据传输率 (b/s) 为 C，则发送方用于发送有效数据的时间为 L/C，在这种情况下，信道的利用率为 (L/C)/T 。

可以发现。求信道的利用率主要是求周期时间 T 和有效数据发送时间 L/C 。

信道吞吐率=信道利用率×发送方的发送速率

## 5. 查缺补漏

1. 信道效率的题目在统考中也出现过，公式为信道利用率 = (L/C)/T。C 是数据传输率，L 为帧长，L/C 就是发送一个帧需要的时间，所以信道利用率就是在周期 T 内发送的帧的个数。T 一般发送第一个帧所用的时间加上传播时延，即 T=L/C=2R（R 是单向传播时延）。（3）

   L/C/(L/C+2R)

2. 信道利用率可以理解为从发送一个帧到接受到这个帧的确认为止的时间内最多可以发送多少数据帧，分别求出整个过程的时间和发送一个帧的时间，相除即可（7）

3. 后退 N 帧协议中，若第一个帧未被确认，则最多只能发窗口大小的数目的帧。（14）

4. 信道利用率=传输帧的有效时间/传输帧的周期。有效时间是 帧长×帧个数/传输速率。周期=有效时间+传播时延（来回）。

