---
title: 网络层与 IP 协议
---

每个 `IP` 标记一个上网地址，`NDS` 协议将其与域名绑定在一起。

## IPV4

- 32 位长度，大约 40 亿个。点分十进制

### 1. IP 分类

- 分为网络号和主机号。

  根据网络号分类为五类：ABCDE。

ABC 类用于通信地址，可以配置在主机或者设备接口上实现通信的。

D 类用于组播地址，实现 1 对多的通信，用于区分组播流量，不能配置在主机上或者设备接口上。可以重复利用，用于主播地址。

E 类为保留地址，已经用于部分协议中，充当协议 IP 地址。

为什么要做 IP 地址的分类？

1. 根据功能的不同进行分类
2. 在 ABC 类中，存在自然掩码：A自然掩码是8，B类自然掩码是16，C类自然掩码是24。

- 私有地址分为

  10.0.0.0~10.255.255.255

  172.16.0.0~172.31.255.255

  

- 特殊 IP 地址

  0.0.0.0：默认路由，指代所有合法 IP 地址。

  127.0.0.1 ~ 127.255.255.255：用于测试，无法作为通信地址使用（如果ping 通了那么自身网卡没问题）

  255.255.255.255 ： 全网广播地址，所有主机接受以广播地址为目的的 IP 地址的数据报文。

  169.254.x.x ：微软专用地址，说明主机无法上网。

### 2

- 掩码

  由连续的 1 和 0 组成，默认情况下是以二进制表示，也可以用点分十进制表示，例如

  192.168.1.1 

  掩码：11111111.11111111.11111111.00000000

  掩码：255.255.255.0

  掩码：/24

  特点：被 1 覆盖的 `IPv4` 地址字段，固定不变；

  ​            被 0 覆盖的 `IPv4` 地址字段，可以变化；

  作用：掩码保证了网络号不可变

- 网络地址的作用

  用来判断两个 `IP` 地址是否处于同一网段（如果处于同一网段，那么只需要二层设备交换机即可同行，如果不处于同一网段，就需要 3 层设备路由器实现通信）

  结合掩码，将主机位置为为 0，生成网络地址；

- 广播地址

  结合掩码，将主机位置位为1，生成广播地址。

  当使用广播地址发送报文时，可以实现一对多的主机通信，属于同一网段的主机都会接收广播地址的数据报文。

- 例子

  192.168.130.1 /25  和 192.168.128.1 /23 掩码不同，不用比

  192.168.130.1 /23  和 192.168.128.1 /23 掩码相同，掩码将其置位为 0， 得到 192.168.130.0 /23  和 192.168.128.0 /23，显然不是同个网段

  如果改为 20 就一样了。
  
- 子网掩码的作用

  防止全 0 或者 全 1 的子网出现 IP 二义性。

### 1. IP 报文

长度： 20 字节到 60 字节。 其中 20 字节为固定报头长度，40 字节为 option 可选项。从左往右解读。

报头长度、总体长度，

version:  版本，一般为 ipv4 或 ipv6。

header length:  包头长度

DS field:  差分服务域标识位，用来对不同的 IP 报文进行分类。例如对一类 IP 进行限速。

total length:  总长度

identification、flags、fragment offset : 在第二行，用于 IP 报文的分片: 设备的接口默认为 1500 字节 （MTU : 最大传输单元）。通过 identification 来分类报文（例如 0x1），利用 fragment offset 对零散的报文进行排序，flags 确认是否收到，（保留位（没啥用），不能分片位（0 表示要分片）、是否还有更多分片（0表示最后一个）），如果丢包就要求发送方重新发送。

ID：用来寻找相同的分片报文

offset：用于对分片报文进行排序

flags：对应的 more 位，当 M=1 表示后续还存在分片报文，如果 M=0 表示后续无分片报文，用于确认分片报文的完整性

不分片：网站为了保证图片的真实色彩，可以将 MTU 调到 5000 字节，或者接受，或者丢了。

TTL（time to live）：默认为 255，每经过一次罗尤其的处理之后， TTL 值减去 1，当路由器收到 TTL=0 的 IP 报文，直接丢弃。作用是：破除环路，避免大量的 IP 报文不断地消耗设备开销与链路开销。

protocol: 协议号，用来表示传输层协议。TCP 协议号为 17，UDP 协议号为 6；通过判断协议做相应的操作。

header checksum：校验和。用于检验 IP 报头传输过程中数据是否出现丢失或者篡改的机制，这是一个算法，发送方会先对数据进行求和，将得到的值存储到 checksum，发送到接收方后，接收方做相同的计算，如果得出的结果不一致，则传输过程中数据出现了丢失或篡改。所以黑客要攻击，需要保证检验和相同的情况下修改内容。

环路问题：路由器形成环，包在中间循环。

### 报文分片接受与确认

## IPV6

128 位长度，很多很多个。

## 抓包

OSI 七层模型

从上往下看抓包，物理层、数据链路层、网络层（IP）、传输层（TCP）、数据。

1. IP 层

### 进制

1. 二进制

   网络中 0 表示不放电、1 表示放电。

2. 十进制

   认类思维。

3. 十六进制

   表示简单，4位二进制转为1位十六进制。

## 地址规划

一个网段可以划分成多个地址，可变长子网掩码

- VLSM：可变长子网掩码

  可用主机数等于 2 的 n 次方减去 2，n 等于 32 减去边长后的掩码。

  子网数等于 2 的 m 次方，m 等于变长后掩码减去自然掩码的数值。

  192.168.1.1 /27

  子网数为：8

  可用主机数为：30

- CIDR：无类域间路由（聚合）

  对多个 ip 进行聚合。相同的字段当做掩码。

  192.168.1.1

  192.168.1.2

  上面两个相同字段为 30 位，掩码为 30。