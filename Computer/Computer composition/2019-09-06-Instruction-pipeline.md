---
title: 5.5 指令流水线
date: 2019-11-27
---

## 1. 指令流水线的基本概念

计算机的流水线把一个重复的过程分解为若干子过程，每个子过程与其他子过程并行执行。由于采用流水线技术只需增加少量硬件就能把计算机的速度提高几倍，因此称为计算机中普遍使用的一种并行处理技术。

### 1.1 指令流水的定义

一条指令的执行过程可分成多个阶段（或过程）。根据计算机的不同，具体的分法也不同。例如可分为取指、分析和执行三个阶段：

1. 取指：根据 PC 内容访问主存储器，取出一条指令送到 IR 中。（取指周期）
2. 分析：对指令操作码进行译码，按照给定的寻址方式和地址地段中的内容形成操作数的有效地址 EA，并从有效数地址 EA 中取出操作数。（间址周期找有效地址，取操作数不在间址周期）
3. 执行：根据操作码字段，完成指令规定的功能，即把运算结果写到通用寄存器或主存中。（执行周期）

当多条指令在处理执行时，可以采用以下三种方式。

1. 顺序执行方式。指令按顺序执行，前一条指令执行完后，才启动下一条指令。设取指、分析、执行三个阶段的时间都相等，用 t 表示，顺序执行 n 条指令所用时间 T 为 `T=3nt` 。

   传统冯·诺伊曼机采用顺序执行方式，又称串行执行方式。其优点是控制简单，硬件代价小；缺点是执行指令的速度较慢，在任何时刻，处理机中只有一条指令在执行，各功能部件的利用率很低。例如取指时内存是忙碌的，而指令执行部件是空闲的。

2. 一次重叠执行方式。这种方式同时进行第 k 条指令的执行阶段和第 k+1 条指令的取指阶段。采用此种方式时，执行 n 条指令所用的时间为 `T=(1+2n)t` 。

   采用一次重叠方式的优点是，程序的执行时间缩短了 1/3，各功能部件的利用率明显提高。但为此需要付出硬件上较大开销的代价，控制过程也比顺序执行复杂。

3. 二次重叠执行方式。为了进一步提高指令的执行速度，可以把取 k+1 条指令提前到分析第 k 条指令的期间完成，而将分析第 k+1 条指令与执行第 k 条指令同时进行。采用此种方式时，执行 n 条指令所用的时间为 `T=(2+n)t` 。

   与顺序执行方式相比，采用二次重叠执行方式能够使指令的执行时间缩短近 2/3。这是一种理想的指令执行方式，在正常情况下，处理机中同时有 3 条指令在执行。

   若每条指令需要通过 4 个或 5 个执行步骤完成，则可以采取 3 次或 4 次重叠执行方式。

### 1.2 流水线的表示方法

通常用时空图来直观地描述流水线的工作过程。（P224）

在时空图中，横坐标表示时间，即输入流水线中的各个任务在流水线中所经过的时间。流水线中各个流水段的执行时间都相等时，横坐标就被分割成相等长度的时间段。纵坐标表示空间，即流水线的每个流水段（对应各执行部件）。

### 1.3 流水线方式的特点

与传统的串行执行方式相比，采用流水线方式具有如下特点：

1. 把一个任务（一条指令或一个操作）分解为几个有联系的子任务，每个子任务由一个专门的功能部件来执行，并依靠多个功能部件并行工作来缩短程序的执行时间。
2. 流水线每个功能段部件后面都要有一个缓冲寄存器，或称锁存器，其作用是保存本流水线段的执行结果，供给下一流水段使用。
3. 流水线中各功能的时间应尽量相等，否则将引起堵塞、断流。
4. 只有连续不断地提供同一种任务时才能发挥流水线的效率，所以在流水线中处理的必须是连续任务。在采用流水线方式工作的处理机中，要在软件和硬件设计等多方面尽量为流水线提供连续的任务。
5. 流水线需要有**装入时间**和**排空时间**。装入时间是指第一个任务进入流水线到输出流水线的时间。排空时间是指最后一个任务进入流水线到输出流水线的时间。

## 2. 流水线的分类

按照不同的分类标志，可以把流水线分成多种不同的种类。下面从几个不同的角度介绍流水线的基本分类方法。

### 2.1 部件功能级、处理机级和处理机间级流水线

根据流水线使用等级的不同，流水线可分为**部件功能级**流水线、**处理机级**流水线和**处理机间**流水线。

部件功能级流水线将复杂的算术逻辑运算组成流水线工作方式。例如，可将浮点加法操作分成求阶差、对阶、尾数相加及结果规格化等 4 个子过程。

处理机级流水把一条指令解释过程分成多个子过程，如前面提到的取指、译码、执行访存和写回 5 个子过程。

处理机间流水线是一种宏流水，其中每个处理机完成某一专门任务，各个处理机得到的结果需存放在与下一个处理机共享的存储器中。

### 2.2 单功能流水线和多功能流水线

按可以完成的功能，流水线可分为单功能流水线和多功能流水线。

单功能流水线是指只能实现一种固定的专门功能的流水线，多功能流水线是指通过各段间的不同连接方式可以同时或不同时地实现多种功能的流水线。

### 2.3 动态流水线和静态流水线

按同一时间内各段之间的连接方式，流水线可分为静态流水线和动态流水线。

静态流水线指在同一时间内，流水线的各段只能按同一种功能的连接方式工作。

动态流水线指在同一时间内，**当某些段正在实现某种运算时，另一些段却正在进行另一种运算**。这样对提高流水线的效率很有好处，但会使流水线控制变得很复杂。

### 2.4 线性流水线和非线性流水线

按流水线的各个功能段之间是否有反馈信号，流水线可分为线性流水线与非线性流水线。

线性流水线中，从输入到输出，每个功能段只允许经过一次，不存在反馈回路。非线性流水线存在反馈回路，从输入到输出的过程中，某些功能段将数次通过流水线，这种流水线适合进行线性递归的运算。

流水线的每个子进程由专用的功能段实现，各功能所需的时间应尽量相等。否则，时间长的功能段将成为流水线的瓶颈。

## 3. 影响流水线的因素

流水线中存在一些相关的情况，它**使下一条指令无法在设计的时钟周期内完成**。这些相关将降低流水线的性能。主要有三种类型的相关。

### 3.1 结构相关（资源冲突）

由于多条指令在**同一时刻争用同一资源**而形成的冲突称为结构相关，有以下两种解决方法：

1. 前一条指令访存时，使后一条相关指令（以及其后续指令）暂停一个时钟周期。
2. 单独设置**数据存储器**和**指令存储器**，使两项操作各自在不同的存储器中进行，这属于资源重复配置。

### 3.2 数据相关（数据冲突）

数据相关指在一个程序中，存在必须等前一条指令执行完才能执行后一条指令的情况，此时这两条指令即为数据相关。当多条指令重叠处理时就会发生冲突，解决的方法有以下几种。

1. 把遇到数据相关的指令及其后续指令都暂停一至几个时钟周期，直到数据相关问题消失后再继续执行，可分为硬件阻塞（stall）和软件插入 `NOP` 指令两种方法。
2. **设置相关专用通路**，即不等前一条指令把计算结果写回寄存器组，下一条指令也不再读寄存器组，而直接把前一条指令的 ALU 的计算结果作为自己的输入数据并开始计算过程，使本来需要暂停的操作变得可以继续执行，这称为**数据旁路技术**。
3. 通过编译器对数据相关的指令编译优化的方法，**调整指令顺序**来解决数据相关。 

### 3.3 控制相关（控制冲突）

当流水线遇到转移指令和其他改变 PC 值的指令而造成**断流**时，会引起控制相关。解决方法有以下几种。

1. 对转移指令进行**分支预测**，尽早生成转移目标地址。分支预测分为简单（静态）预测和动态预测。静态预测总是预测条件不满足，即继续执行分支指令的后续指令。动态预测根据程序执行的历史情况，进行动态预测调整，有较高的预测准确率。
2. **预取**转移成功和不成功两个控制流方向上的目标指令。
3. 加快和提前形成条件码。
4. 提高转移方向的猜准率。

注意：**Cache 缺失的处理过程也会引起流水线阻塞**。在不过多增加硬件成本的情况下，如何尽可能地提高指令流水线的运行效率（处理能力）是选用指令流水线技术必须解决的关键问题。

## 4. 流水线的性能指标

衡量流水线性能的主要指标有吞吐率、加速比和效率。下面以线性流水线为例分析流水线的主要性能指标，其分析方法和有关公式**也适用于非线性流水线**。

### 4.1 流水线的吞吐率

在指令级流水线中，吞吐率是指单位时间内流水线所完成的任务数量，或输出结果的数量。计算流水线吞吐量（TP）的最基本的公式为 `TP=n/Tk` 。式中，n 是任务数，`Tk` 是处理完 n 个任务所用的时间。下面以流水线中各段执行时间都相等为例来讨论流水线的吞吐率。

在输入流水线中的任务连续的理想情况下，一条 k 段线性流水线能够在 `k+n-1` 个时钟周期内完成 n 个任务。k 为流水线的段数，Δt 为时钟周期。得出流水线的实际**吞吐率**为 `TP=n/{(k+n-1)Δt}` 。连续输入的任务数 n → ∞ 时，得最大吞吐率为 `TPmax = 1/Δt` （单位时间的任务数，吞吐率和吞吐量其实是同一个概念）。

### 4.2 流水线的加速比

完成同样一批任务，不使用流水线所用的时间与使用流水线所用的时间之比，称为流水线的加速比。

设 `T0` 表示不使用流水线时的执行时间，即顺序执行所用的时间，`Tk` 表示使用流水线时的执行时间，则计算流水线加速比（S）的基本公式为 `S=T0/Tk` 。

若流水线各段执行的时间都相等，则一条 k 段流水线完成 n 个任务所需的时间为 `Tk=(k+n-1)Δt` 。而不使用流水线，即顺序执行 n 个任务时，所需的时间为 `T0=knΔt` 。将 `T0` 和 `Tk` 值带入上式，得实际加速比为 

`S=knΔt/[(k+n-1)Δt]=kn/(k+n-1)` 

连续输入的任务数 n→∞ 时，最大加速比为 `Smax = k` 。

### 4.3 流水线的效率

流水线的设备利用率称为流水线的效率。在时空图上，流水线的效率定义为完成 n 个任务占用的时空区有效面积，与 n 个任务所用的时间及 k 个流水线所围成的时空区总面积之比。因此，流水线的效率包含了时间和空间两个因素。

n 个任务占用的时空区有效面积就是顺序执行 n 个任务所使用的总时间 `T0` ，而 n 个任务所用的时间与 k 个流水段所围成的时空区总面积为 `kTk` ，其中 `Tk` 是流水线完成 n 个任务所使用的总时间，因此计算流水线效率（E）的一般公式为

```markdown
E = n 个任务占用的时空区有效面积/n 个任务所用的时间与 k 个流水线段所围成的时空区总面积
  = T0 / (kTk)
```

若流水线的各段执行时间相等，上式中的分子部分是 n 个任务实际占用的有效面积，分母部分是完成 n 个任务所用的时间与 k 个流水线段所围成的总面积。因此，通过时空图来计算流水线的效率非常方便。

流水线的各段执行时间均相等，当连续输入的任务数 n → ∞ 时，最高效率 `Emax = 1` 。

## 5. 超标量流水线的基本概念

### 5.1 超标量流水线技术

每个时钟周期内可**并发多条独立指令**，即以并行操作方式将两条或多条指令编译并执行，为此**需配置多个功能部件**。

超标量计算机可结合动态调度技术（硬件实现），或通过**编译优化技术**（软件实现），把可并行执行的指令搭配起来，挖掘更多的指令并行性。

### 5.2 超流水线技术

在一个时钟周期内再分段，在一个时钟周期内**一个功能部件使用多次**。

不能调整指令的执行顺序，靠编译程序解决优化问题（软件调整）。

### 5.3 超长指令字

由编译程序挖掘出**指令间潜在的并行性**，将多条能并行操作的指令组合成一条具有多个操作码字段的超长指令字（可达几百位），为此需要采用多个处理部件。

## 6. 习题

1. 空间并行和时间并行指什么，流水线属于哪个？
2. 超标量流水线特点
3. 流水线数据通路包括
4. 控制相关的解决方法
5. 流水线总时间计算公式
6. PC 的无条件跳转公式
7. 五流水段流水线：IF、ID、EXE、MEM、WB
8. 五流水段流水线发生冲突的情况
9. 程序的 Cache 命中率
10. TLB 的访问计算细节

## 7. 习题答案

1. 空间并行即资源重复，主要指多个功能部件共同执行同一个任务的不同部分，典型的入多处理机系统。时间并行即时间重叠，让多个功能部件在时间上相互错开，轮流重叠执行不同任务的相同部分。流水线 CPU 利用的是时间并行性。

2. 同一时钟周期发射多条指令，多个处理器同时处理，以空间换时间。能结合动态调度技术提高指令执行并行性。

3. 算术逻辑运算部件（ALU）、通用寄存器组和取指部件，由秩序和逻辑电路和时序逻辑电路组成，不含生成控制信号的控制部件。

4. 加入若干空操作、调整指令顺序、预测技术。转发（旁路）技术用于数据冒险。

5. n-1+k，前 n-1 条只需要 1 个时钟周期（重叠逻辑），最后一条需要 k 个时钟周期。

6. PC + n×(1+OFFSET)，n 是一条指令的编码单位数。

7. 取指阶段不会阻塞，但译码开始阻塞。

8. IF（Instruction Fetch）：取指，所有指令共有的部分，去指令 Cache 取指，不和 数据 Cache 冲突。

   ID（Instruction Decode）：译码，所有指令共有的部分，将 IR 的指令译码，此时也有默认取寄存器数（数据 Cache）

   这两部分（IF 和 ID）不受指令类型的影响。

   EXE（Execute）：运用 ALU，其中加法取反等运算指令直接对操作数进行运算，访存指令用于计算下址。

   MEM（Memory）：访存指令用于访存过程，不访存的指令直接跳过。

   WB（Write Back）：运算指令将结果输出到寄存器，load 指令访存写回寄存器。

   整个指令过程中各段时间是相同的，统一受钟沿控制。整个指令执行过程中只有 EXE 部分使用 ALU，避免了资源冲突。由于 IF、MEM 都有可能访存，通常设置指令 Cache 和数据 Cache 避免资源冲突。

9. 若上一条指令的 WB 写回的寄存器与本指令对应的寄存器相同，会发生资源冲突。这时有 3 个时钟周期的阻塞，使本指令 ID 应在上一条 WB 后，如下图

   | 指令 | 1    | 2    | 3    | 4    | 5    | 6    | 7    | 8    | 9    | 10   | 11   | 12   | 13   | 14   |
   | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
   | I1   | IF   | ID   | EX   | M    | WB   |      |      |      |      |      |      |      |      |      |
   | I2   |      | IF   | ID   | EX   | M    | WB   |      |      |      |      |      |      |      |      |
   | I3   |      |      | IF   |      |      |      | ID   | EX   | M    | WB   |      |      |      |      |
   | I4   |      |      |      |      |      |      | IF   |      |      |      | ID   | EX   | M    | WB   |

   第三条指令阻塞了 3 个时钟周期。

   跳转指令（JMP）（bra）：由于流水线默认直接提取下一条指令，若指令为 JMP 或 JC（根据情况预判跳转结果），在没有分支预测的情况下，默认有 3 个时钟周期的阻塞使本指令 ID 应在上一条 WB 后，bne 表示条件跳转（branch not equal）指令。

10. 程序存储在程序 Cache 中，若程序只在一个  Cache 中，又是循环，那么除了第一次，其他都命中。

11. 如果 TLB 访问不命中但不缺页，下一次不会再访问（通过内存得到），如果 TLB 访问不命中且缺页，下次还会访问一次，只要取数，都会访问 TLB。

