---
title: 7.4 IO 方式
date: 2019-12-7
---

输入/输出系统实现主机与 I/O 设备之间的**数据传送**，可以采用不同的控制方式、各种方式在代价、性能、解决问题的着重点等方面各不相同，常用的 I/O 方式有程序查询、程序中断、DMA 和通道等，其中前两种方式更**依赖于 CPU 中程序指令的执行**。

## 1. 程序查询方式

信息交换的控制**完全由主机执行程序实现**，程序查询方式接口中设置一个数据缓冲寄存器（数据端口）和一个设备状态寄存器（状态端口）。主机进行 I/O 操作时，先发出询问信号，**读取设备的状态**并根据设备状态决定下一步操作究竟是进行数据传送还是等待。

程序查询方式的工作流程如下：（P276）

1. CPU 执行初始化程序，并预置传送参数。
2. 向 I/O 接口发出命令字，启动 I/O 设备。
3. 从外设接口读取其状态信息。
4. CPU 不断查询 I/O 设备状态，直到外设准备就绪。
5. 传送一次数据。
6. 修改地址和计数器参数。
7. 判断传送是否结束，若未结束转第 3 步，直到计数器为 0。

在这种控制方式下，CPU 一旦启动 I/O，就必须**停止现行程序的运行**，并在现行程序中插入一段程序。程序查询方式的主要特点是 CPU 有 “踏步” 等待现象，CPU 与 I/O 串行工作。这种方式的接口设计简单、设备量少，但 CPU 在信息传送过程中要花费很多时间来查询和等待，而且在一段时间内只能和一台外设交换信息，效率大大降低。

## 2. 程序中断方式

中断是现代计算机有效合理地发挥效能和提高效率的一个十分重要的功能。CPU 中通常设有处理中断的机构（中断系统），以解决各种中断的共性问题。

### 2.1 中断的基本概念

程序中断是指在计算机执行现行程序的过程中，出现某些急需处理的异常情况或特殊请求，CPU 暂时中止现行程序，而转去对这些异常情况或特殊请求进行处理，在处理完毕后 CPU 又自动返回到现行程序的断点处，继续执行原程序。

程序中断的作用如下：

1. 实现 CPU 与 I/O 设备的并行工作。
2. 处理**硬件故障**和**软件错误**。
3. 实现人机交互，用户干预机器需要用到中断系统。
4. 实现多道程序、分时操作，多道程序的切换需要借助于中断系统。
5. 实时处理需要借助中断系统来实现快速响应。
6. 实现应用程序和操作系统（管态程序）的切换，称为 “软中断”（软件到软件的切换）。
7. 多处理器系统中各处理器之间的信息交流和任务切换。

程序中断方式的思想：CPU 在程序中安排好于某个时刻启动某台外设，然后 CPU 继续执行原来的程序，不需要像查询方式那样一直等待外设准备就绪。在可以响应中断的条件下，CPU 暂时中止正在执行的程序，转去执行中断服务程序为外设服务，在中断服务程序中完成一次主机与外设之间的数据传送，传送完成后，CPU 返回原来的程序。

### 2.2 程序中断方式工作流程

1. 中断请求

   中断请求是指中断源向 CPU 发送中断请求信号。

   1. 内中断和外中断

      中断源是请求 CPU 中断的设备或事件，一台计算机允许有多个中断器。根据中断源的类别，可把中断源分为内中断和外中断两种。

      每个中断源向 CPU 发出中断请求的时间是随机的。为记录中断事件并区分不同的中断源，中断系统需对每个中断源设置中断请求标记触发器 INTR，当其状态为 `1` 时，表示中断源有请求。这些触发器可组成中断请求标记寄存器，该寄存器可集中在 CPU 中，也可分散在各个中断源中。

      外中断是指**来自处理器和内存以外**的部件引起的中断，包括 I/O 设备发出的 I/O 中断、外部信号中断（如用户按 Esc 键），以及各种定时器引起的**时钟中断**等。外中断在狭义上一般称为中断（后文若未说明，一般是指外中断）。

      内中断主要是指在处理器和内存内部产生的中断，包括程序运算引起的各种错误，如地址非法、校验错、页面失效、存取访问控制错、算术操作溢出、数据格式非法、除数为零、非法指令、用户程序执行特权指令、分时系统中的时间片中断及用户态到核心态的切换等。

   2. 硬件中断和软件中断

      硬件中断：通过外部的硬件产生的中断。硬件中断属于外中断。

      软件中断：通过某条指令产生的中断，这种中断是可以编程实现的。软件中断属于内中断。

   3. 非屏蔽中断和可屏蔽中断

      非屏蔽中断：非屏蔽中断是一种硬件中断，此种中断通过不可屏蔽中断请求 NMI 控制，不受中断标志位 IF 的影响，即使在关中断（IF=0）的情况下也会被响应。

      可屏蔽中断：可屏蔽中断也是一种硬件中断，此种中断通过中断请求标记触发器 INTR 控制，且受中断标志位 IF 的影响，在**关中断情况下不接受中断请求**。

      也就是说，可屏蔽中断和非屏蔽中断**均是外中断**。

2. 中断判优

   中断系统在任一瞬间只能响应一个中断源的请求。由于许多中断源提出中断请求的时间都是随机的，因此当多个中断源同时提出请求时，需通过**中断判优逻辑确定响应哪个中断源的请求**，例如故障中断的优先级别较高，然后是 I/O 中断。

   中断判优既可以用硬件实现，又可用软件实现。硬件实现是通过**硬件排队器**实现的，它既可以设置在 CPU 中，又可以分散在各个中断源中，软件实现是通过**查询程序**实现的。

   一般来说，硬件故障中断属于最高级，其次是软件中断，非屏蔽中断优于可屏蔽中断，DMA 请求优于 I/O 设备传送的中断请求，高速设备优于低速设备，输入设备优于输出设备，实时设备优于普通设备等。

3. CPU 响应中断的条件

   CPU 在满足一定的条件下响应中断源发出的中断请求，并经过一些特定的操作，转去**执行中断服务程序**。

   CPU 响应中断必须满足以下 3 个条件。

   1. 中断源有中断请求。
   2. CPU 允许中断及开中断。
   3. 一条指令执行完毕，且没有更紧迫的任务。

   注意：I/O 设备的就绪时间是随机的，而 CPU 在统一的时刻即每条指令**执行阶段结束前向接口发出中断查询信号**，以获取 I/O 的中断请求，也就是说，CPU 响应中断的时间是**在每条指令执行阶段的结束时刻**。这里说的中断仅指外中断，内中断不属于此类情况。

4. 中断隐指令

   CPU 响应中断后，经过某些操作，转去执行中断服务程序。这些操作是**由硬件直接实现的**，我们将它称为中断隐指令。中断隐指令并不是指令系统中一条真正的指令，它没有操作码，所以中断隐指令是一种不允许也不可能为用户使用的特殊指令。它所完成的操作如下：

   1. 关中断（区分可屏蔽中断）。在中断服务程序中，为了保护中断现场（即 CPU 主要寄存器中的内容）期间**不被新的中断所打断**，必须关中断，从而保证被中断的程序在中断服务程序执行完毕后能接着正确地执行。
   2. 保存断点。为保证在中断服务程序执行完毕后能正确地返回到原来的程序，必须将原来程序的断点（即程序计数器（PC）的内容）保存起来。
   3. 引出中断服务程序。引出中断服务程序的实质是，取出**中断服务程序的入口地址**并传送给程序计数器（PC）。

5. 中断向量

   不同的设备有不同的中断服务程序，每个中断服务程序都有一个入口地址，CPU 必须找到这个入口地址，即中断向量，把系统中的**全部中断向量集中存放到存储器的某个区域内**，这个存放中断向量的存储区就称为中断向量表，即中断服务程序入口地址表。

   CPU 响应中断后，中断硬件会**自动**将中断向量地址传送到 CPU，由 CPU 实现程序的切换，这种方法称为中断向量法，采用中断向量法的中断称为向量中断。

   注意：中断向量是中断服务程序的入口地址，中断向量地址是指**中断服务程序的入口地址的地址**。

6. 中断处理过程

   不同计算机的中断处理过程各具特色，大多数中断处理流程如下（P279）：

   1. 关中断。处理器响应中断后，首先要保护程序的现场状态，在保护现场的过程中，CPU 不应响应更高级中断源的中断请求。否则，若现场保存不完整，在中断服务程序结束后，也就不能正确地恢复并继续执行现行程序。
   
   2. 保存断点。为保证中断服务程序执行完毕后能正确地返回原来的程序，必须将原来的程序的断点保存起来。断点可以压入堆栈，也可以存入主存的特定单元中。
   
   3. 引出中断服务程序。引出中断服务程序的实质是，**取出中断服务程序的入口地址送入程序计数器**（PC）。
   
      通常有两种方法寻址中断服务程序的入口地址：**硬件向量**和**软件查询**法。
   
      硬件向量法**通过硬件产生中断向量地址**，再由中断向量地址找到中断服务程序的入口地址。
   
      软件查询法用软件编程的办法寻找入口地址。
   
      注意：硬件产生的实际上是**中断类型号**，而中断类型号指出了中断向量存放的地址，故能产生中断向量地址。
   
   4. 保存现场和屏蔽字。进入中断服务程序后首先要保存现场，现场信息一般是指程序状态字，中断屏蔽寄存器和 CPU 中某些寄存器的内容。
   
   5. 开中断。允许更高级中断请求得到响应，实现中断嵌套。
   
   6. 执行中断服务程序。这是中断系统的核心。
   
   7. 关中断。保证在恢复现场和屏蔽字时不被中断。
   
   8. 恢复现场和屏蔽字。将现场和屏蔽字恢复到原来的状态。
   
   9. 开中断、中断返回。中断服务程序的最后一条指令通常是一条中断返回指令，使其返回到原程序的断点处，以便继续执行原程序。
   
   其中，1~3 在 CPU 进入中断周期后，由中断隐指令（硬件自动）完成；4~9 由中断服务程序完成。
   
   注意：**恢复现场是指在中断返回前**，必须将寄存器的内容恢复到中断处理前的状态，这部分工作由中断服务程序完成。中断返回由中断服务程序的最后一条中断返回指令完成。

### 2.3 多重中断和中断屏蔽技术

若 CPU 在执行中断服务程序的过程中，又出现了新的更高优先级的中断请求，而 CPU 对新的中断请求不予响应，则这种中断称为单重中断。若 CPU 暂停现象的中断服务程序，转去处理新的中断请求，则这种中断称为多重中断，又称中断嵌套。（P280）

中断屏蔽技术主要用于多重中断。CPU 要具备多重中断的功能，必须满足下列条件：

1. 在中断服务程序中提前设置开中断指令。
2. 优先级别高的中断源有权中断优先级别低的中断源。

每个中断源都有一个屏蔽触发器，1 表示屏蔽该中断的请求，0 表示可以正常申请，所有屏蔽触发器组合在一起便构成一个屏蔽字寄存器，**屏蔽字寄存器的内容称为屏蔽字**。

关于中断屏蔽字的设置及多重中断程序执行的轨迹，下面通过实例说明。

```markdown
设某机有 4 个中断源 A、B、C、D，其硬件排队优先次序为 A>B>C>D，现要求将中断处理次序改为 D>A>C>B。（P280）

1. 写出每个中断源对应的屏蔽字。
   在中断处理次序改为 D>A>C>B 后，D 具有最高优先级，可以屏蔽其他所有中断，且不能中断自身，
   故 D 对应的屏蔽字为 1111；A 具有次高优先级，只能被 D 中断，故 A 对应的屏蔽字为 1110，
   以此类推，C 为 0110，B 为 0100。

2. B、D、A、C 分别在 5、10、35、60μs 时刻发出中断请求，画出 CPU 执行次序的轨迹。
   (设每个中断源的中断服务程序时间均为 20μs)

   纵轴为不同的服务程序，横轴为时间轴，判断随时间变化是否被中断来改变纵轴即可。
```

## 3. DMA 方式

DMA 方式是一种**完全由硬件进行成组信息传送**的控制方式，它具有**程序中断**的优点，即在数据准备阶段，CPU 与外设并行工作。DMA 方式在外设与内存之间开辟一条 “直接数据通道”，信息传送不再经过 CPU，降低了 CPU 在传送数据时的开销，因此称为**直接存储器存取方式**。由于数据传送不经过 CPU，也就不需要保护、恢复 CPU 现场等烦琐操作。

这种方式适用于磁盘机、磁带机等**高速设备大批量数据的传送**，它的硬件开销比较大。在 DMA 方式中，中断的作用仅限于**故障**和**正常传送结束时**的处理。

### 3.1 DMA 方式的特点

主存和 DMA 接口之间有一条直接数据通路。由于 DMA 方式传送数据不需要经过 CPU，因此不必中断现行程序，I/O 与主机并行工作，程序和传送并行工作。

DMA 方式具有下列特点。

1. 它使主存与 CPU 的固定联系脱钩，主存即可被 CPU 访问，又可被外设访问。
2. 在数据块传送时，**主存地址的确定**、**传送数据的计数**等都由硬件电路直接实现。
3. 主存中要开辟**专用缓冲区**，及时供给和接收外设的数据。
4. DMA 传送速度快，CPU 和外设**并行工作**，提高了系统效率。
5. DMA 在传送开始前要通过程序进行**预处理**，结束后要通过中断方式进行**后处理**。

### 3.2 DMA 控制器的组成

在 DMA 方式中，对数据传送过程进行控制的硬件称为 **DMA 控制器**（DMA 接口）。当 I/O 设备需要进行数据传送时，通过 DMA 控制器向 CPU 提出 DMA 传送请求，CPU 响应之后将让出系统总线，由 DMA 控制器**接管总线**进行数据传送。其主要功能如下：

1. 接受外设发出的 DMA 请求，并向 CPU 发出**总线请求**。
2. CPU 响应此总线请求，发出总线响应信号，接管总线控制权，进入 DMA 操作周期。
3. 确定传送数据的主存单元地址及长度，并自动修改主存地址计数和传送长度计数。
4. 规定数据在主存和外设间的传送方向，发出读写等控制信号，执行数据传送操作。
5. 向 CPU 报告 DMA 操作的结束。

一个简单的 DMA 控制器包括（P282）：

- 主存地址计数器：存放**要交换数据的主存地址**。
- 传送长度计数器：记录传送数据的长度，计数溢出时，数据即传送完毕，自动发中断请求信号。
- 数据缓冲寄存器：暂存每次要发送的数据。
- DMA 请求触发器：每当 I/O 设备准备好数据后，给出一个控制信号，使 DMA 请求触发器置位。
- “控制/状态” 逻辑：由**控制和时序电路**及**状态标志**组成，用于指定传送方向，修改传送参数，并对 DMA 请求信号和 CPU 响应信号进行协调和同步。
- 中断机构：当一个数据块传送完毕后触发中断机构，向 CPU 提出中断请求。

在 DMA 传送过程中，DMA 控制器将接管 **CPU 的地址总线、数据总线和控制总线**，CPU 的主存控制信号被禁止使用。而当 DMA 传送结束后，将恢复 CPU 的一切权利并开始执行其操作。由此可见，**DMA 控制器必须具有控制系统总线的能力**。

### 3.3 DMA 的传送方式

主存和 DMA 控制器之间有一条**数据通路**，因此主存和 I/O 设备之间交换信息时，不通过 CPU。但当 I/O 设备和 CPU 同时访问主存时，可能发生冲突，为了有效地使用主存，DMA 控制器与 CPU 通常采用以下 3 种方式使用主存。

1. 停止 CPU 访问主存。这种方式是当外设需要传送成组数据时，由 DMA 接口向 CPU 发送一个信号，要求 CPU 放弃地址线、数据线和有关控制线的使用权，DMA 接口获得总线控制权后，开始进行数据传送。数据传送结束后，DMA 接口通知 CPU 可以使用主存，并把总线控制权交还给 CPU。在这种传送过程中，CPU 基本处于不工作状态或保持原始状态。
2. DMA 与 CPU 交替访存。这种方式适用于 CPU 的工作周期比主存存取周期长的情况。例如，若 CPU 的工作周期是 1.2μs，主存的存取周期小于 0.6μs，则可将一个 CPU 周期分为 `C1` 和 `C2` 两个周期，其中 `C1` 专供 DMA 访存，C2 专供 CPU 访存。这种方式不需要总线使用权的申请、建立和归还过程，总线使用权是通过 `C1` 和 `C2` 分时控制的。
3. 周期挪用（或周期窃取）。这种方式是前两种方式的折中。当 I/O 设备没有 DMA 请求时，CPU 按程序的要求访问主存，一旦 I/O 设备有了 DMA 请求，就会遇到 3 种情况。第 1 种是此时 CPU 不在访存（如 CPU 正在执行乘法指令），故 I/O 的访存请求与 CPU 未发生冲突；第 2 种是 CPU 正在访存，此时必须待存取周期结束后，CPU 再将总线占有权让出；第 3 种是 I/O 和 CPU 同时请求访存，出现访存冲突，此时 CPU 要暂时放弃总线占有权，由 I/O 设备挪用一个或几个存取周期。

### 3.4 DMA 的传送过程

DMA 的数据传送过程分为预处理、数据传送和后处理 3 个阶段：

1. 预处理。由 CPU 完成一些必要的准备工作。首先，CPU 执行几条 I/O 指令，用以测试 I/O 设备状态，向 DMA 控制器的有关寄存器置初值、设置传送方向、启动该设备等。然后，CPU 继续执行原来的程序，直到 I/O 设备准备好发送的数据（输入情况）或接收的数据（输出情况）时，I/O 设备向 DMA 控制器发送 DMA 请求，再由 DMA 控制器向 CPU 发送总线请求（有时将这两个过程统称为 DMA 请求），用以传输数据。
2. 数据传送。DMA 的数据传输可以以单字节（或字）为基本单位，也可以以数据块为基本单位。对于以数据块为单位的传送（如硬盘），DMA 占用总线后的数据输入和输出操作都是通过循环来实现的。需要指出的是，这一循环也是由 DMA 控制器（而非通过 CPU 执行程序）实现的，即数据传送阶段完全由 DMA（硬件）控制。
3. 后处理。DMA 控制器向 CPU 发送中断请求，CPU 执行中断服务程序做 DMA 结束处理，包括校验送入主存的数据是否正确、测试传送过程中是否出错（错误则转入诊断程序）及决定是否继续使用 DMA 传送其他数据块等。（P283）

### 3.5 DMA 方式和中断方式的区别

DMA 方式和中断方式的重要区别如下：

1. 中断方式是程序的切换，需要保护和恢复现场；而 DMA 方式除了预处理和后处理，其他时候不占用 CPU 的任何资源。
2. 对中断请求的响应只能发生在每条指令执行完毕时（即指令的执行周期后）；而对 DMA 请求的响应可以发生在每个机器周期结束时（在取指周期、间址周期、执行周期后均可），只要 CPU 不占用总线就可被响应。
3. 中断传送过程需要 CPU 的干预；而 DMA 传送过程不需要 CPU 的干预，故数据传输率非常高，适合于高速外设的成组数据传送。
4. DMA 请求的优先级高于中断请求。
5. 中断方式具有对异常事件的处理能力，而 DMA 方式仅局限于传送数据块的 I/O 操作。
6. 从数据传送来看，中断方式靠程序传送，DMA 方式靠硬件传送。

## 4. 习题

1. 单级中断系统中，中断服务程序内的执行顺序
2. 中断判优和总线仲裁方法的区别和联系？
3. 程序中断和 DMA 方式的区别和联系？
4. 各种中断优先级比较
5. 主存故障引起的中断
6. 配有通道的计算机中，用户程序需要输入/输出时，引起的中断是
7. 谁完成将允许中断触发器置 0？
8. DMA 方式下数据从内存传送到外设经过的路径是？
9. 中断优先级由什么决定
10. 中断 IO 方式控制打印的情况下，CPU 和打印控制接口中的 IO 端口之间交换的信息不可能是
11. CPU 用于外设 IO 的时间占整个 CPU 时间的百分比的计算方法。  
12. CPU 和 DMA 控制器同时要求使用存储器总线时，哪个优先级更高？
13. 主存带宽计算
14. 中断响应阶段 CPU 进行了哪些操作？
15. CPU 从设备中接收到字符的时间包括？
16. 若设备速度比 CPU 的 IO 处理速度快，会怎样

## 5. 习题答案

1. 关中断、保存断点、识别中断源；保护现场、中断事件处理、恢复现场、开中断、中断返回。

   前三步由硬件完成，然后交给中断服务程序完成。

2. 独立请求方式的每个 I/O 接口都有各自的总线请求和总线同意线，共 2n 根控制线以获得高相应速度。

   总线冲裁方式一般是指 IO 设备争用总线的判优方式，而中断判优方式一般是指 IO 设备争用 CPU 的判优方式。

   中断判优逻辑既可以通过硬件实现，又可以通过软件实现。

3. 程序中断需要保护现场，DMA 方式不需要保护现场

   程序中断：CPU 与外设并行工作，传送与主程序串行工作

   DMA 方式：CPU 与外设并行工作，传送与主程序并行工作

   中断 IO 方式下数据传送通过软件完成，DMA 方式下数据传送通过硬件完成。

   中断响应发生在一条指令执行结束后，DMA 响应发生在一个总线事务完成后。

4. 硬件故障→访管指令→外部中断→程序性→重新启动

5. 机器校验中断，属于内中断

6. 访管中断，从用户态到核心态，调用操作系统提供的接口。

7. 中断隐指令

8. DMA 方式不经过 CPU，输出从内存到数据总线，传送到 DMA 控制器的 DMAC 中，再传送给外设。类似这样的传输路径称为数据通路。

9. 屏蔽字

10. 主存地址。中断 IO 交换的是数据、设备状态、控制命令。只有在 DMA  方式下才设计地址。

11. 根据外设 IO 的速度和一次传输的数据量求出 1 s 内的中断次数，进而求出中断需要的时钟周期数，除以时钟频率，得到百分比

12. DMA，因为 DMA 请求得不到及时响应，IO 传输数据可能会丢失。

13. 主存宽带×低位交叉的个数/存储周期

14. 关中断，、保护断点、识别中断源

15. 设备将字符送至 IO 端口的时间、中断响应时间和中断服务时间。其中中断响应时间和中断服务时间 CPU 也参与。

16. 设备发过去的数据 CPU 来不及接收，导致数据丢失。

