---
title: 6.2 总线仲裁
date: 2019-11-30
---

为解决多个主设备同时竞争总线控制权的问题，应当采用总线仲裁部件，以某种方式选择一个主设备优先获得总线控制权。只有获得了总线控制权的设备，才能开始传送数据。

总线仲裁方式按其仲裁控制机构的设置可分为**集中仲裁方式**和**分布仲裁方式**两种。

## 1. 集中仲裁方式

总线控制逻辑基本上集中于一个设备（如 CPU）中。**将所有的总线请求集中起来**，利用一个特定的裁决算法进行裁决，称为集中仲裁方式。集中仲裁方式有链式查询方式、计数器定时查询和独立请求方式三种。

### 1.1 链式查询方式

总线上所有的部件共用一根总线请求线，当有部件请求使用总线时，需经此线发总线请求信号到总线控制器。由总线控制器检查总线是否忙，若总线不忙，则立即发总线响应信号，经总线响应线 BG 串行地从一个部件传送到下一个部件，依次查询。若响应信号到达的部件无总线请求，则该信号立即传送到下一个部件；若响应信号到达的部件有总线请求，则信号被截住，不再传下去。（P252）

在链式查询中，部件离总线控制器越近，其优先级越高；部件离总线控制器越远，其优先级越低。

优点：链式查询方式优先级固定。此外，只需很少几根控制线就能按一定优先次序实现总线控制，结构简单，扩充容易。

缺点：对硬件电路的故障敏感，且优先级不能改变。当优先级高的部件频繁请求使用总线时，会使优先级较低的部件长期不能使用总线。

### 1.2 计数器定时查询方式

它采用一个计数器控制总线使用权，相对链式查询方式**多了一组设备地址线**，**少了一根总线响应线 BG**。它仍共用一根总线请求线，当总线控制器收到总线请求信号并判断总线空闲时，计数器开始计数，计数值通过设备地址线发向各个部件。当地址线上的计数值与请求使用总线设备的地址一致时，该设备获得总线控制权，同时中止计数器的计数及查询。（P253）

优点：计数可从 `0` 开始，此时一旦设备的优先次序被固定，设备的优先级就按 `0,1,...,n` 的顺序降序排列，而且固定不变；计数也可从上一次的终点开始，即采用一种循环方法，此时设备使用总线的优先级相等；计数器的初值还可由程序设置，故优先次序可以改变，且这种方式对电路的故障没有链式查询方式敏感。

缺点：增加了控制线数（若设备有 n 个，则大致需要 `log2n上取整 +2` 条控制线，一条控制线发出 0 或 1），控制也比相对链式查询复杂。

### 1.3 独立请求方式

每个设备均有一对总线请求线 `BRi` 和总线允许线 `BGi` 。当总线上的部件需要使用总线时，经各自的总线请求线发送总线请求信号，在总线控制器中排队，当总线控制器按一定的优先次序决定批准某个部件的请求时，给该部件发送总线响应信号，该部件接到此信号后就获得了总线使用权，开始传送数据。

优点：响应速度快，总线允许信号 BG 直接从控制器发送到有关设备，而不必在设备间传递或查询，而且对优先次序的控制相当灵活。

缺点：控制线数量多（设备有 n 个，需要 2n+1 条控制线，其中加的那条控制线位 BS 线，其作用是让设备向总线控制部件反馈已使用完总线），总线控制逻辑更复杂。

为方便记忆，下面归纳了 3 种集中仲裁方式的区别与联系（假设设备有 n 个）。

|          | 链式查询                              | 计数器定时查询                                               | 独立请求                                 |
| -------- | ------------------------------------- | ------------------------------------------------------------ | ---------------------------------------- |
| 控制线数 | 3（总线请求 1，总线忙 1，总线允许 1） | `log2n上取整 + 2` （总线请求 1，总线忙 1，总线允许 `log2n上取整`） | 2n+1（总线请求 n，总线允许 n，总线忙 1） |
| 优点     | 优先级固定，结构简单，扩充容易。      | 优先级灵活                                                   | 响应速度快；优先级灵活                   |
| 缺点     | 对电路故障敏感，优先级不灵活          | 控制线多，控制复杂                                           | 控制线多，控制复杂                       |

注：计数器定时查询方式的优缺点介于链式查询和独立请求方式之间（如优先级的灵活性、对电路故障的敏感等），读者应灵活掌握 3 种方式的概念和特征。

## 2. 分布仲裁方式

分布仲裁方式不需要中央仲裁器，每个潜在的主模块都有自己的**仲裁号**和**仲裁器**。当它们有总线请求时，就会把它们各自唯一的仲裁号发送到**共享的仲裁总线**上，每个仲裁器将从仲裁总线上得到的仲裁号与自己的仲裁号进行比较。若仲裁总线上的仲裁号优先级高，则它的总线请求不予响应，并撤销它的仲裁号。最后，获胜者的仲裁号保留在仲裁总线上。

## 3. 习题

1. 计数器定时查询下，若每次计数从上一次计数的中止点开始，则
2. ”总线忙“ 信号的建立者是
3. 总线易错点

## 4. 习题答案

1. 每个设备使用总线的机会相等。若总是从 0 开始，那么离总线控制器最近的设备具有最高的优先级。所以定时查询的优先级是可变的。

2. 获得总线控制权的设备。在总线控制中，申请使用总线的设备向总线控制器发出 “总线请求”，由总线控制器进行裁决。若经裁决允许该设备使用总线，就由总线控制器向该设备发出 “总线允许” 信号，该设备收到信号后发出 “总线忙” 的信号，通知其他设备总线已被占用。该设备使用完总线时，将 “总线忙” 信号撤销，释放总线。

3. 总线忙信号是**由获得总线使用权的设备**而非总线控制器发出的.

   计数器定时查询方式只需要总线忙和总线请求信号线，而**不需要总线同意信号**。