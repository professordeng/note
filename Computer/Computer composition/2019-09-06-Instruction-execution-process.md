---
title: 5.2 指令执行过程
date: 2019-11-24
---

## 1. 指令周期

CPU 从主存中每**取出并执行**一条指令所需的全部时间称为指令周期，即 CPU 完成一条指令的时间。

指令周期常用若干机器周期来表示，一个机器周期又包含若干时钟周期（也称节拍或 T 周期，它是 CPU 操作的最基本单位）。每个指令周期内的机器周期数可以不等，每个机器周期内的节拍也可以不等（取指令的机器周期和取有效地址的机器周期可以不等）。（P187）

对于无条件转移指令 `JMP X` ，在执行时不需要访问主存，只包含取指阶段（包括取指和分析）和执行阶段，所以其指令周期仅包含**取指周期**和**执行周期**。

对于间接寻址的指令，为了取操作数，需要先访问一次主存，取出有效地址，然后访问主存，取出操作数，所以还需包括**间址周期**。间址周期介于取指周期和执行周期之间。

当 CPU 采用中断方式实现主机和 I/O 设备的信息交换时，CPU 在每条指令执行结束前，都要发中断查询信号，若有中断请求，则 CPU 进入中断响应阶段，又称**中断周期**。这样，一个完整的指令周期应包括取指、间址、执行和中断 4 个周期。

上述 4 个工作周期都有 CPU 访存操作，只是访存的目的不同。取指周期是为了取指令，间址周期是为了取有效地址，执行周期是为了取操作数，中断周期是为了保存程序断点。

为了区别不同的工作周期，在 CPU 内设置 4 个标志触发器 FE、IND、EX 和 INT，它们分别对应取指、间址、执行和中断周期，并以 1 表示有效，分别由 `1→FE` 、`1→IND` 、`1→EX` 和 `1→INT` 这 4 个信号控制。

注意：中断周期中的进栈操作是将 SP 减 1，这和传统意义上的进栈操作相反，原因是计算机的堆栈中都是向低地址增加，所以进栈操作是减 1 而不是加 1 。

## 2. 指令周期的数据流

数据流是根据指令要求依次访问的数据序列。在指令执行的不同阶段，要求依次访问的数据序列是不同的。而且对于不同的指令，它们的数据流往往也是不同的。

### 2.1 取指周期

取指周期的任务是根据 PC 中的内容从主存中取出指令代码并存放在 IR 中。

PC 中存放的是指令的地址，根据次地址从内存单元中取出的是指令，并放在指令寄存器 IR 中，取指令的同时，PC 加 1。

取指周期的数据流向如下：

1. PC → MAR → 地址总线 → 主存。
2. CU 发出控制信号 → 控制总线 → 主存。
3. 主存 → 数据总线 → MDR → IR（存放指令）。
4. CU 发出读命令 → PC 内容加 1。

### 2.2 间址周期

间址周期的任务是取操作数有效地址。以一次间址为例，将指令中的地址码送到 MAR 并送至地址总线，此后 CU 向存储器发出读命令，以获取有效地址并存至 MDR。（P188）

间址周期的数据流向如下：

1. `Ad(IR)` （或 MDR）→ MAR → 地址总线 → 主存。
2. CU 发出读命令 → 控制总线 → 主存。
3. 主存 → 数据总线 → MDR（存放有效地址）。

其中，`Ad(IR)` 表示取出 IR 中存放的指令字的地址字段。

### 2.3 执行周期

执行周期的任务是根据 IR 中的指令字的操作码和操作数通过 ALU 操作产生执行结果。不同指令的执行周期操作不同，因此没有统一的数据流向。

### 2.4 中断周期

中断周期的任务是处理中断请求。假设程序断点存入堆栈中，并用 SP 指示栈顶地址，而且进栈操作是先修改栈顶指针，后存入数据。（P189）

中断周期的数据流向如下

1. CU 控制将 SP 减 1，SP → MAR → 地址总线 → 主存。
2. CU 发出写指令 → 控制总线 → 主存。
3. PC → MDR → 数据总线 → 主存（程序断点存入主存）。
4. CU（中断服务程序的入口地址）→ PC 。

总的来说就是：SP 减 1 后放到 MAR，PC 放到 MDR，然后写入主存。

## 3. 指令执行方案

一个指令周期通常要包括几个时间段（执行步骤），每个步骤完成指令的一部分功能，几个依次执行的步骤完成这条指令的全部功能。出于性能和硬件成本等考虑，可以选用 3 种不同的方案来安排指令的执行步骤。

### 3.1 单指令周期

对所有指令都选用相同的执行时间来完成，称为单指令周期方案。此时每条指令都在固定的时钟周期内完成，指令之间串行执行，即下一条指令只能在前一条指令执行结束后才能启动。因此，指令周期取决于执行时间最长的指令的执行时间。对于那些本来可以在更短时间内完成的指令，要使用这个较长的周期来完成，会降低整个系统的运行速度。

### 3.2 多指令周期

对不同类型的指令选用不同的执行步骤来完成，称为多指令周期方案。指令之间串行执行，即下一条指令只能在前一条指令执行结束后才能启动。但可选用不同个数的时钟周期来完成不同指令的执行过程，指令需要几个周期就为其分配几个周期，而不再要求所有指令占用相同的执行时间。

### 3.3 流水线方案

指令之间可以并行执行的方案，称为流水线方案，其追求的目标是力争在每个时钟脉冲周期完成一条指令的执行过程（只在理想情况下才能达到该效果）。这种方案通过在每个时钟周期启动一条指令，尽量让多条指令同时运行，但各自处在不同的执行步骤中。

## 4. 习题

1. 采用 DMA 方式传递数据时，每传送一个数据就要占用？
2. 机器周期是啥？
3. 指令字长的某些规律。
4. CPU 如何区分指令和数据？
5. 中断周期的前后分别是什么周期？

## 5. 习题答案

1. 存取周期
2. 通常把通过一次总线事务访问一次主存或 I/O 的时间定为一个机器周期；一个指令周期通常包含多个机器周期；不同的指令周期包含的机器周期数可能不同。
3. 指令字长等于存储字长的前提下，取指周期等于机器周期；指令字长和机器字长的长度没有任何关系。机器字长是机器一次能处理的数据位数，存取字长指数据线的条数（一次传输的数据量）。
4. 指令周期的不同阶段，取指阶段取指令，执行阶段取数据，如果有间址阶段的话取数据地址。
5. 执行周期和下一条指令的取指周期。



